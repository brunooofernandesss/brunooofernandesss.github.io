<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Sa√∫de Coletiva, APS e Vigil√¢ncia Epidemiol√≥gica.</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      background-color: #f4f4f4;
    }

    .quiz-container {
      max-width: 800px;
      width: 100%;
    }

    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }

    .card {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .question {
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }

    .options {
      margin-top: 15px;
    }

    /* Estilos unificados para todas as op√ß√µes (est√°ticas e din√¢micas) */
    .option, label.option, label, #newQuestionsContent label {
      display: flex; /* Para alinhar imagem e texto */
      align-items: center;
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      position: relative; /* Para posicionar a tesoura */
    }

    /* FOR√áA a remo√ß√£o de inputs de radio em QUALQUER lugar */
    .option input[type="radio"], 
    label input[type="radio"],
    #newQuestionsContent input[type="radio"],
    #newQuestionsContent label input[type="radio"] {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        position: absolute !important;
        left: -9999px !important;
    }

    .option:hover, 
    label.option:hover, 
    label:hover,
    #newQuestionsContent label:hover {
      background-color: #e9e9e9;
    }

    .option.selected, 
    label.option.selected, 
    label.selected,
    #newQuestionsContent label.selected {
      background-color: #d1e7dd;
      border-color: #28a745;
    }

    .option.correct, 
    label.option.correct, 
    label.correct,
    #newQuestionsContent label.correct {
      background-color: #d4edda;
      border-color: #28a745;
    }

    .option.incorrect, 
    label.option.incorrect, 
    label.incorrect,
    #newQuestionsContent label.incorrect {
      background-color: #f8d7da;
      border-color: #dc3545;
    }

    .submit-btn {
      display: block;
      width: 100%;
      padding: 15px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 18px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-top: 30px;
    }

    .submit-btn:hover {
      background-color: #0056b3;
    }

    .results {
      text-align: center;
      margin-top: 30px;
      font-size: 20px;
      font-weight: bold;
      color: #333;
    }

    .scissor-icon {
      margin-right: 10px; /* Espa√ßo entre a tesoura e o texto da op√ß√£o */
      width: 20px; /* Ajuste conforme o tamanho da sua imagem */
      height: 20px; /* Ajuste conforme o tamanho da sua imagem */
      opacity: 0.5; /* Transpar√™ncia como no original */
      cursor: pointer;
    }

    .scissor-icon.hidden {
      display: none;
    }

    .struck-through {
      text-decoration: line-through;
      color: #888;
    }

    .comment {
      margin-top: 10px;
      padding: 10px;
      background-color: #f0f0f0;
      border-left: 4px solid #007bff;
      font-style: italic;
      color: #555;
      display: none; /* Escondido por padr√£o */
    }
    .comment.show {
      display: block; /* Mostrado quando ativado */
    }

    /* Estilos para o bot√£o de navega√ß√£o de erro / diagn√≥stico */
    .error-nav-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #dc3545; /* Vermelho para erro */
      color: white;
      border: none;
      border-radius: 50%; /* Torna o bot√£o redondo */
      width: 60px;
      height: 60px;
      font-size: 24px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      display: none; /* Escondido por padr√£o */
      flex-direction: column; /* Para empilhar o √≠cone e o contador */
      padding: 5px; /* Ajuste o padding para acomodar texto maior */
      box-sizing: border-box; /* Garante que padding n√£o aumente o tamanho total */
      text-align: center;
    }

    .error-nav-btn:hover {
      background-color: #c82333;
    }

    .error-nav-btn .arrow-icon {
      font-size: 30px; /* Tamanho da seta */
      line-height: 1; /* Ajuste para centralizar */
    }

    .error-nav-btn .button-text {
      font-size: 12px; /* Tamanho do texto abaixo da seta */
      line-height: 1;
      margin-top: 2px; /* Espa√ßo entre a seta e o texto */
    }

    /* Estilos para a se√ß√£o de diagn√≥stico de erros */
    .error-diagnosis-section {
        margin-top: 50px;
        padding: 30px;
        background-color: #ffe0b2; /* Um laranja claro ou similar */
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        display: none; /* Escondido por padr√£o */
        text-align: center;
        font-size: 1.1em;
        color: #333;
    }

    .error-diagnosis-section h2 {
        color: #e65100; /* Laranja mais escuro */
        margin-bottom: 20px;
        font-size: 1.8em;
    }

    .error-diagnosis-section ul {
        list-style: none; /* Remove marcadores de lista */
        padding: 0;
        margin: 0;
    }

    .error-diagnosis-section li {
        background-color: #ff9800; /* Laranja */
        color: white;
        padding: 8px 15px;
        margin: 8px 0;
        border-radius: 5px;
        display: inline-block; /* Para que os itens fiquem lado a lado */
        margin-right: 10px;
        font-weight: bold;
    }
    .error-diagnosis-section li:last-child {
        margin-right: 0;
    }
 .card-bloco {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
      background: #fff;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
  </style>
</head>
<body>
  <div class="quiz-container">
    <h1 style="text-align:center; margin-bottom: 30px;">Sa√∫de Coletiva, APS e Vigil√¢ncia Epidemiol√≥gica.</h1>
    <div class="card-bloco" id="quiz"></div>
    <button class="submit-btn" id="verifyAnswersBtn">Verificar Respostas</button>

    <button class="generate-questions-btn submit-btn" id="generateNewQuestionsBtn" style="display:none;">
      Gerar Novas Perguntas
    </button>

    <div class="results card-bloco" id="results"></div>
    <div id="statusMessage" style="text-align: center; margin-top: 10px; font-weight: bold; color: #007bff;"></div>

    <div class="error-diagnosis-section card-bloco" id="errorDiagnosis">
      <h2>Diagn√≥stico de Erros</h2>
      <p>Parece que voc√™ precisa revisar os seguintes assuntos:</p>
      <ul id="topicsToReview"></ul>
    </div>

    <div class="generated-questions-section card-bloco" id="generatedQuestionsSection" style="display:none;">
      <h2>Novas Perguntas Geradas</h2>
      <div id="newQuestionsContent"></div>
    </div>
  </div>
  
  <button class="error-nav-btn" id="errorNavBtn" style="display:none;">
    <span class="arrow-icon"></span>
    <span class="button-text"></span>
  </button>

  <script>
    const quizContainer = document.getElementById("quiz");
    const resultsContainer = document.getElementById("results");
    const errorNavBtn = document.getElementById("errorNavBtn");
    const arrowIcon = errorNavBtn.querySelector(".arrow-icon");
    const buttonText = errorNavBtn.querySelector(".button-text");
    const errorDiagnosisSection = document.getElementById("errorDiagnosis");
    const topicsToReviewList = document.getElementById("topicsToReview");
    const generateNewQuestionsBtn = document.getElementById("generateNewQuestionsBtn");
    const generatedQuestionsSection = document.getElementById("generatedQuestionsSection");
    const newQuestionsContent = document.getElementById("newQuestionsContent");
    const statusMessage = document.getElementById("statusMessage");

    let wrongQuestionIndices = [];
    let errorCountByTopic = {};
    let totalAnsweredQuestionsByTopic = {};
    let currentWrongQuestionIndex = -1;
    let hasErrors = false;
    let isShowingErrors = false;
    let isShowingDiagnosis = false;

    // Inicializa a visibilidade das se√ß√µes no carregamento
    errorDiagnosisSection.style.display = 'none';
    topicsToReviewList.innerHTML = '';
    statusMessage.textContent = '';

    const questions = [     {         question: "Sobre o processo de territorializa√ß√£o na Aten√ß√£o B√°sica, √© correto afirmar que:",         options: [             "O territ√≥rio da equipe deve ser definido com base apenas na divis√£o geogr√°fica do munic√≠pio.",             "A territorializa√ß√£o busca ampliar o acesso √† alta complexidade hospitalar.",             "A responsabilidade da equipe √© apenas sobre os pacientes que procuram a unidade de sa√∫de.",             "O territ√≥rio deve ser definido considerando a vulnerabilidade social e o v√≠nculo com a popula√ß√£o.",             "N√£o √© necess√°rio mapear os servi√ßos e equipamentos da regi√£o durante a territorializa√ß√£o."         ],         correctAnswer: "O territ√≥rio deve ser definido considerando a vulnerabilidade social e o v√≠nculo com a popula√ß√£o.",         comment: "A territorializa√ß√£o envolve mais do que delimita√ß√£o geogr√°fica: considera v√≠nculos, acessos e grau de vulnerabilidade social da popula√ß√£o.",         topic: "Territorializa√ß√£o na APS"     },     {         question: "O genograma √© uma ferramenta importante na ESF, pois permite:",         options: [             "Avaliar as rela√ß√µes entre a fam√≠lia e os servi√ßos comunit√°rios externos.",             "Organizar o atendimento com base em queixas cl√≠nicas individuais.",             "Registrar apenas os diagn√≥sticos de doen√ßas cr√¥nicas.",             "Compreender a estrutura familiar e as rela√ß√µes afetivas ao longo do tempo.",             "Elaborar exclusivamente o plano medicamentoso do Projeto Terap√™utico Singular."         ],         correctAnswer: "Compreender a estrutura familiar e as rela√ß√µes afetivas ao longo do tempo.",         comment: "O genograma √© uma representa√ß√£o gr√°fica que mostra as rela√ß√µes familiares, composi√ß√£o e eventos importantes ao longo das gera√ß√µes.",         topic: "Ferramentas de Abordagem Familiar"     },     {         question: "Sobre o Projeto Terap√™utico Singular (PTS), assinale a alternativa correta:",         options: [             "O PTS deve ser constru√≠do exclusivamente pelo m√©dico e pelo paciente.",             "O objetivo do PTS √© otimizar o uso de medicamentos e exames complementares.",             "O PTS busca personalizar o cuidado por meio da elabora√ß√£o coletiva com a equipe, o paciente e os cuidadores.",             "O PTS √© aplicado apenas em pacientes com transtornos mentais severos.",             "O PTS √© usado apenas em interna√ß√µes hospitalares prolongadas."         ],         correctAnswer: "O PTS busca personalizar o cuidado por meio da elabora√ß√£o coletiva com a equipe, o paciente e os cuidadores.",         comment: "O Projeto Terap√™utico Singular √© constru√≠do de forma interdisciplinar e coletiva, focando na singularidade e autonomia do sujeito.",         topic: "Projeto Terap√™utico Singular (PTS)"     },     {         question: "O conceito de determinantes sociais da sa√∫de (DSS) refere-se a:",         options: [             "Fatores gen√©ticos que causam doen√ßas heredit√°rias.",             "Condi√ß√µes sociais e econ√¥micas que influenciam a sa√∫de e podem ser modificadas por pol√≠ticas p√∫blicas.",             "Programas de rastreio gen√©tico populacional.",             "Crit√©rios laboratoriais para diagn√≥stico de doen√ßas infecciosas.",             "Exclusivamente ao acesso a servi√ßos de sa√∫de terci√°ria."         ],         correctAnswer: "Condi√ß√µes sociais e econ√¥micas que influenciam a sa√∫de e podem ser modificadas por pol√≠ticas p√∫blicas.",         comment: "Os DSS explicam como as condi√ß√µes de vida e trabalho impactam o processo sa√∫de-doen√ßa e exigem a√ß√µes intersetoriais.",         topic: "Determinantes Sociais da Sa√∫de"     },     {         question: "Sobre a defini√ß√£o de caso em uma investiga√ß√£o de surto, √© correto afirmar:",         options: [             "Deve conter apenas crit√©rios cl√≠nicos para facilitar a inclus√£o de todos os casos.",             "√â usada apenas para diagn√≥stico individual de pacientes em consult√≥rio.",             "Deve incluir crit√©rios cl√≠nicos, laboratoriais e epidemiol√≥gicos, como tempo, lugar e pessoa.",             "Deve ser utilizada apenas ap√≥s a conclus√£o da investiga√ß√£o.",             "Pode variar a cada paciente, conforme seu hist√≥rico individual."         ],         correctAnswer: "Deve incluir crit√©rios cl√≠nicos, laboratoriais e epidemiol√≥gicos, como tempo, lugar e pessoa.",         comment: "Uma defini√ß√£o de caso padronizada (cl√≠nica, laboratorial e epidemiol√≥gica) √© essencial para monitorar a din√¢mica do surto.",         topic: "Investiga√ß√£o de Surtos"     },     {         question: "O ecomapa √© uma ferramenta que permite √† equipe da ESF:",         options: [             "Realizar o rastreio de doen√ßas infectocontagiosas.",             "Planejar exclusivamente o tratamento medicamentoso de um paciente.",             "Visualizar as rela√ß√µes do n√∫cleo familiar com institui√ß√µes, servi√ßos e redes de apoio da comunidade.",             "Avaliar apenas o hist√≥rico de doen√ßas familiares.",             "Organizar o territ√≥rio com base no n√∫mero de prontu√°rios ativos."         ],         correctAnswer: "Visualizar as rela√ß√µes do n√∫cleo familiar com institui√ß√µes, servi√ßos e redes de apoio da comunidade.",         comment: "O ecomapa foca nas conex√µes da fam√≠lia com o ambiente externo, revelando redes de apoio social, servi√ßos e poss√≠veis conflitos.",         topic: "Ferramentas de Abordagem Familiar"     },     {         question: "A vigil√¢ncia epidemiol√≥gica √© caracterizada por:",         options: [             "Realizar atendimento cl√≠nico individualizado.",             "Focar apenas em doen√ßas gen√©ticas e heredit√°rias.",             "Coletar, analisar e interpretar dados de sa√∫de para controle e preven√ß√£o de doen√ßas.",             "Monitorar exclusivamente doen√ßas ocupacionais.",             "Elaborar apenas diagn√≥sticos laboratoriais."         ],         correctAnswer: "Coletar, analisar e interpretar dados de sa√∫de para controle e preven√ß√£o de doen√ßas.",         comment: "Sua fun√ß√£o principal √© fornecer subs√≠dios para o planejamento e execu√ß√£o de a√ß√µes de controle e preven√ß√£o de agravos √† sa√∫de.",         topic: "Vigil√¢ncia Epidemiol√≥gica"     },     {         question: "Um surto √© caracterizado por:",         options: [             "A ocorr√™ncia de uma doen√ßa por um longo per√≠odo, em v√°rias regi√µes do pa√≠s.",             "O aumento s√∫bito do n√∫mero de casos de uma doen√ßa em uma popula√ß√£o espec√≠fica, em um curto per√≠odo.",             "A redu√ß√£o cont√≠nua dos casos de uma doen√ßa cr√¥nica.",             "A erradica√ß√£o de uma doen√ßa em n√≠vel mundial.",             "A presen√ßa constante de uma doen√ßa em uma popula√ß√£o."         ],         correctAnswer: "O aumento s√∫bito do n√∫mero de casos de uma doen√ßa em uma popula√ß√£o espec√≠fica, em um curto per√≠odo.",         comment: "O surto ocorre quando h√° um excesso de casos em rela√ß√£o ao esperado em uma √°rea geogr√°fica restrita ou institui√ß√£o.",         topic: "Epidemiologia de Agravos"     },     {         question: "A notifica√ß√£o compuls√≥ria de doen√ßas √© um instrumento de:",         options: [             "Controle financeiro da unidade de sa√∫de.",             "Planejamento de cirurgias eletivas.",             "Vigil√¢ncia em sa√∫de para detec√ß√£o precoce e resposta r√°pida a agravos.",             "Organiza√ß√£o de escalas m√©dicas.",             "Avalia√ß√£o da performance de profissionais de sa√∫de."         ],         correctAnswer: "Vigil√¢ncia em sa√∫de para detec√ß√£o precoce e resposta r√°pida a agravos.",         comment: "A notifica√ß√£o permite a detec√ß√£o oportuna de eventos que podem colocar a sa√∫de p√∫blica em risco.",         topic: "Sistemas de Informa√ß√£o e Notifica√ß√£o"     },     {         question: "A territorializa√ß√£o deve considerar:",         options: [             "Apenas os crit√©rios pol√≠ticos e administrativos do munic√≠pio.",             "O n√∫mero de consultas m√©dicas por unidade de sa√∫de.",             "As condi√ß√µes sociais, ambientais, econ√¥micas e epidemiol√≥gicas da popula√ß√£o.",             "O tempo de atua√ß√£o da equipe de sa√∫de na regi√£o.",             "A quantidade de m√©dicos dispon√≠veis por bairro."         ],         correctAnswer: "As condi√ß√µes sociais, ambientais, econ√¥micas e epidemiol√≥gicas da popula√ß√£o.",         comment: "Uma territorializa√ß√£o eficaz considera a complexidade multidimensional dos fatores que afetam a sa√∫de da comunidade.",         topic: "Territorializa√ß√£o na APS"     },     {         question: "A Estrat√©gia Sa√∫de da Fam√≠lia (ESF) tem como base o princ√≠pio da:",         options: [             "Hospitaliza√ß√£o precoce.",             "Aten√ß√£o especializada.",             "Integralidade do cuidado e v√≠nculo com a comunidade.",             "Alta complexidade assistencial.",             "Privatiza√ß√£o dos servi√ßos de sa√∫de."         ],         correctAnswer: "Integralidade do cuidado e v√≠nculo com a comunidade.",         comment: "O v√≠nculo e a integralidade garantem um cuidado humanizado e cont√≠nuo, focado nas necessidades reais daquela popula√ß√£o.",         topic: "Estrat√©gia Sa√∫de da Fam√≠lia"     },     {         question: "Um dos objetivos principais da APS √©:",         options: [             "Aumentar a realiza√ß√£o de cirurgias eletivas.",             "Oferecer cuidados de sa√∫de pr√≥ximos ao cotidiano das pessoas, com a√ß√µes de promo√ß√£o, preven√ß√£o, diagn√≥stico, tratamento e reabilita√ß√£o.",             "Promover interna√ß√µes hospitalares imediatas.",             "Substituir servi√ßos especializados por atendimentos em pronto-socorro.",             "Centralizar os atendimentos em grandes hospitais."         ],         correctAnswer: "Oferecer cuidados de sa√∫de pr√≥ximos ao cotidiano das pessoas, com a√ß√µes de promo√ß√£o, preven√ß√£o, diagn√≥stico, tratamento e reabilita√ß√£o.",         comment: "A APS busca ser a porta de entrada preferencial e o centro da coordena√ß√£o do cuidado no sistema de sa√∫de.",         topic: "Princ√≠pios da Aten√ß√£o Prim√°ria"     },     {         question: "No contexto da APS, o acolhimento significa:",         options: [             "Atender pacientes apenas por ordem de chegada.",             "Direcionar automaticamente todos os usu√°rios para a consulta m√©dica.",             "Oferecer escuta qualificada e humanizada, acolhendo as necessidades dos usu√°rios de forma resolutiva.",             "Restringir o atendimento a usu√°rios cadastrados.",             "Realizar triagem para encaminhamento hospitalar."         ],         correctAnswer: "Oferecer escuta qualificada e humanizada, acolhendo as necessidades dos usu√°rios de forma resolutiva.",         comment: "O acolhimento n√£o √© apenas 'recepcionar', mas sim responsabilizar-se pela necessidade do outro de forma √©tica.",         topic: "Acolhimento e Humaniza√ß√£o"     },     {         question: "A defini√ß√£o de caso para investiga√ß√£o de surtos permite:",         options: [             "A realiza√ß√£o de diagn√≥stico individual preciso para cada paciente.",             "Identificar os casos que devem ser inclu√≠dos na investiga√ß√£o, com base em crit√©rios padronizados.",             "A exclus√£o de casos suspeitos que n√£o foram confirmados laboratorialmente.",             "A redu√ß√£o do tempo de atendimento cl√≠nico.",             "A substitui√ß√£o do tratamento medicamentoso por medidas epidemiol√≥gicas."         ],         correctAnswer: "Identificar os casos que devem ser inclu√≠dos na investiga√ß√£o, com base em crit√©rios padronizados.",         comment: "Padronizar o que √© 'caso' permite contar corretamente os doentes e entender a magnitude do evento sanit√°rio.",         topic: "Investiga√ß√£o de Surtos"     },     {         question: "Sobre os instrumentos de an√°lise do territ√≥rio utilizados na APS, √© correto afirmar:",         options: [             "O mapa falado n√£o tem validade cient√≠fica e n√£o deve ser usado.",             "O genograma √© usado para analisar as rela√ß√µes sociais extrafamiliares.",             "O ecomapa complementa o genograma ao mostrar conex√µes do n√∫cleo familiar com recursos externos.",             "A territorializa√ß√£o √© um processo desnecess√°rio na pr√°tica da ESF.",             "O territ√≥rio deve ser analisado apenas uma vez, no in√≠cio do trabalho da equipe."         ],         correctAnswer: "O ecomapa complementa o genograma ao mostrar conex√µes do n√∫cleo familiar com recursos externos.",         comment: "Enquanto o genograma olha 'para dentro' da fam√≠lia (gen√©tica/afetos), o ecomapa olha 'para fora' (trabalho, igreja, lazer, sa√∫de).",         topic: "Ferramentas de Abordagem Familiar"     },     {         question: "Sobre os princ√≠pios da Aten√ß√£o Prim√°ria √† Sa√∫de (APS), √© correto afirmar que:",         options: [             "A equidade implica oferecer os mesmos servi√ßos para todos os usu√°rios, independentemente de sua condi√ß√£o social.",             "A universalidade garante que apenas os residentes legais tenham acesso aos servi√ßos de sa√∫de.",             "A integralidade pressup√µe a oferta de a√ß√µes promocionais, preventivas, curativas e reabilitadoras, de forma articulada e cont√≠nua.",             "A APS deve priorizar procedimentos de alta complexidade para ampliar a resolutividade.",             "O v√≠nculo entre profissional e usu√°rio deve ser evitado para manter a imparcialidade t√©cnica."         ],         correctAnswer: "A integralidade pressup√µe a oferta de a√ß√µes promocionais, preventivas, curativas e reabilitadoras, de forma articulada e cont√≠nua.",         comment: "A integralidade busca atender √†s diversas necessidades de sa√∫de da popula√ß√£o de forma hol√≠stica e ininterrupta.",         topic: "Princ√≠pios do SUS e da APS"     },     {         question: "O acolhimento como diretriz na Aten√ß√£o B√°sica visa:",         options: [             "Estabelecer um espa√ßo de escuta qualificada, responsabiliza√ß√£o e humaniza√ß√£o do atendimento ao usu√°rio.",             "Realizar apenas a triagem cl√≠nica dos pacientes mais graves.",             "Direcionar os usu√°rios exclusivamente ao atendimento m√©dico.",             "Restringir o acesso de usu√°rios n√£o cadastrados na unidade.",             "Priorizar o atendimento por ordem de chegada, independentemente da queixa."         ],         correctAnswer: "Estabelecer um espa√ßo de escuta qualificada, responsabiliza√ß√£o e humaniza√ß√£o do atendimento ao usu√°rio.",         comment: "Um acolhimento eficaz fortalece o v√≠nculo e aumenta a confian√ßa da comunidade no servi√ßo de sa√∫de.",         topic: "Acolhimento e Humaniza√ß√£o"     },     {         question: "Na investiga√ß√£o de um surto de Doen√ßa Diarreica Aguda (DDA) em uma comunidade atendida pela ESF, a primeira medida a ser tomada √©:",         options: [             "Iniciar o tratamento medicamentoso em todos os casos suspeitos.",             "Confirmar a exist√™ncia do surto por meio da compara√ß√£o com o n√∫mero esperado de casos na popula√ß√£o afetada.",             "Realizar exames laboratoriais em toda a popula√ß√£o da √°rea afetada.",             "Notificar apenas os casos graves aos √≥rg√£os superiores.",             "Encaminhar todos os pacientes para hospitais de refer√™ncia."         ],         correctAnswer: "Confirmar a exist√™ncia do surto por meio da compara√ß√£o com o n√∫mero esperado de casos na popula√ß√£o afetada.",         comment: "A confirma√ß√£o t√©cnica de que o n√∫mero de casos ultrapassou o limiar end√™mico √© o passo inicial obrigat√≥rio.",         topic: "Investiga√ß√£o de Surtos"     },     {         question: "Sobre o papel da equipe de Sa√∫de da Fam√≠lia (ESF) na vigil√¢ncia em sa√∫de, assinale a alternativa correta:",         options: [             "A vigil√¢ncia √© uma responsabilidade exclusiva das secretarias estaduais de sa√∫de.",             "A eSF deve integrar a√ß√µes de vigil√¢ncia epidemiol√≥gica, sanit√°ria e ambiental no cuidado cotidiano.",             "A equipe deve notificar apenas agravos relacionados ao trabalho.",             "A vigil√¢ncia deve ser feita apenas ap√≥s solicita√ß√£o da gest√£o municipal.",             "A vigil√¢ncia √© um setor separado da aten√ß√£o prim√°ria, sem articula√ß√£o com os servi√ßos da UBS."         ],         correctAnswer: "A eSF deve integrar a√ß√µes de vigil√¢ncia epidemiol√≥gica, sanit√°ria e ambiental no cuidado cotidiano.",         comment: "A equipe de sa√∫de da fam√≠lia est√° na ponta, sendo fundamental para identificar riscos ambientais e sanit√°rios precocemente.",         topic: "Vigil√¢ncia em Sa√∫de"     },     {         question: "O mapa falado, utilizado na territorializa√ß√£o, consiste em:",         options: [             "Um levantamento estat√≠stico realizado por georreferenciamento via sat√©lite.",             "Um modelo padronizado de mapeamento oferecido pelo Minist√©rio da Sa√∫de.",             "Um recurso qualitativo em que os profissionais constroem coletivamente o conhecimento do territ√≥rio a partir das falas e viv√™ncias da popula√ß√£o.",             "Um instrumento de triagem populacional feito a partir do genograma.",             "Um relat√≥rio t√©cnico-cientico utilizado apenas em auditorias da gest√£o municipal."         ],         correctAnswer: "Um recurso qualitativo em que os profissionais constroem coletivamente o conhecimento do territ√≥rio a partir das falas e viv√™ncias da popula√ß√£o.",         comment: "O mapa falado √© uma constru√ß√£o social do espa√ßo, valorizando a subjetividade e a hist√≥ria da comunidade local.",         topic: "Territorializa√ß√£o na APS"     } ];

    function buildQuiz() {
      const output = [];

      questions.forEach((currentQuestion, questionNumber) => {
        const options = [];
        for (let i = 0; i < currentQuestion.options.length; i++) {
          options.push(
            `<label class="option" data-question="${questionNumber}" data-value="${currentQuestion.options[i]}">
              <img src="tesouras.png" class="scissor-icon" onclick="event.stopPropagation(); this.parentNode.classList.toggle('struck-through');">
              ${currentQuestion.options[i]}
            </label>`
          );
        }

        output.push(
          `<div class="card" id="question-${questionNumber}" data-topic="${currentQuestion.topic}">
            <div class="question">${currentQuestion.question}</div>
            <div class="options">${options.join("")}</div>
            <div class="comment" id="comment-${questionNumber}"></div>
          </div>`
        );
      });

      quizContainer.innerHTML = output.join("");
    }

    function showResults() {
      wrongQuestionIndices = [];
      errorCountByTopic = {};
      totalAnsweredQuestionsByTopic = {};
      currentWrongQuestionIndex = -1;
      hasErrors = false;
      isShowingErrors = false;
      isShowingDiagnosis = false;

      errorDiagnosisSection.style.display = 'none';
      topicsToReviewList.innerHTML = '';
      statusMessage.textContent = '';

      // Busca por todas as perguntas: est√°ticas e din√¢micas
      const allQuestionCards = document.querySelectorAll('.quiz-container .card, #newQuestionsContent .card');
      let correctAnswersCount = 0;
      let totalQuestionsAnswered = 0;

      console.log('üîç Verificando', allQuestionCards.length, 'perguntas...');

      allQuestionCards.forEach((card, index) => {
        const questionEl = card.querySelector('.question') || card.querySelector('p');
        if (!questionEl) return;

        const questionText = questionEl.textContent.trim();
        const optionsContainer = card.querySelector('.options') || card;
        const allOptions = optionsContainer.querySelectorAll('.option, label.option, label');
        const userAnswerElement = optionsContainer.querySelector('.option.selected, label.selected');
        const commentDiv = card.querySelector('.comment');

        const questionTopic = card.dataset.topic || "T√≥pico n√£o informado";
        
        console.log(`üìù Pergunta ${index + 1}: T√≥pico = "${questionTopic}"`);
        console.log(`üîç Encontradas ${allOptions.length} alternativas`);
        
        // Remove classes anteriores
        allOptions.forEach(option => {
          option.classList.remove('correct', 'incorrect', 'selected');
        });
        if (commentDiv) commentDiv.classList.remove('show');

        let correctAnswerValue = null;
        let questionComment = null;

        // Verifica se √© pergunta est√°tica ou din√¢mica
        const isStatic = card.id && card.id.startsWith('question-');
        if (isStatic) {
          // Pergunta est√°tica - busca nos dados originais
          const questionData = questions.find(q => q.question.trim() === questionText);
          if (questionData) {
            correctAnswerValue = questionData.correctAnswer.trim();
            questionComment = questionData.comment;
          }
        } else {
          // Pergunta din√¢mica - busca pela op√ß√£o marcada como correta
          const correctOpt = optionsContainer.querySelector('.option[data-answer="true"], label[data-answer="true"]');
          if (correctOpt) {
            correctAnswerValue = correctOpt.dataset.value?.trim() || correctOpt.textContent.trim();
            console.log(`‚úÖ Resposta correta encontrada: "${correctAnswerValue}"`);
          } else {
            console.log('‚ùå Nenhuma resposta correta encontrada para pergunta din√¢mica');
          }
          
          // Busca coment√°rio no pr√≥prio card ou no div comment
          const commentElement = card.querySelector('.comment');
          if (commentElement && commentElement.textContent.trim()) {
            questionComment = commentElement.textContent.trim();
          }
        }

        // Processa resposta do usu√°rio e aplica colora√ß√£o
        let userAnswer = null;
        if (userAnswerElement) {
          userAnswerElement.classList.add('selected');
          userAnswer = userAnswerElement.dataset.value?.trim() || userAnswerElement.textContent.trim();
          totalQuestionsAnswered++;
          totalAnsweredQuestionsByTopic[questionTopic] = (totalAnsweredQuestionsByTopic[questionTopic] || 0) + 1;

          console.log(`üë§ Resposta do usu√°rio: "${userAnswer}"`);
          console.log(`üéØ Resposta correta: "${correctAnswerValue}"`);

          // Verifica se a resposta est√° correta
          if (userAnswer === correctAnswerValue) {
            correctAnswersCount++;
            console.log(`‚úÖ Resposta correta!`);
          } else {
            hasErrors = true;
            errorCountByTopic[questionTopic] = (errorCountByTopic[questionTopic] || 0) + 1;
            console.log(`‚ùå Resposta incorreta para t√≥pico: ${questionTopic}`);
          }
        }

        // Aplica colora√ß√£o: SEMPRE marca a correta de verde, e a errada de vermelho se foi marcada
        allOptions.forEach(option => {
          const optionValue = option.dataset.value?.trim() || option.textContent.trim();
          
          // Marca a resposta correta de verde SEMPRE
          if (optionValue === correctAnswerValue) {
            option.classList.add('correct');
            console.log(`üü¢ Marcando como correta: "${optionValue}"`);
          }
          
          // Se o usu√°rio marcou uma resposta E ela est√° errada, marca de vermelho
          if (userAnswer && optionValue === userAnswer && userAnswer !== correctAnswerValue) {
            option.classList.add('incorrect');
            console.log(`üî¥ Marcando como incorreta: "${optionValue}"`);
          }
        });

        // Mostra coment√°rio se dispon√≠vel
        if (commentDiv && questionComment) {
          commentDiv.textContent = questionComment;
          commentDiv.classList.add('show');
        }
      });

      // Exibe resultados
      resultsContainer.textContent = `Voc√™ acertou ${correctAnswersCount} de ${totalQuestionsAnswered} quest√µes respondidas.`;

      console.log('üìä Erros por t√≥pico:', errorCountByTopic);
      console.log('üìä Total por t√≥pico:', totalAnsweredQuestionsByTopic);

      // Gera diagn√≥stico de erros
      if (hasErrors) {
        for (const topic in errorCountByTopic) {
          const errors = errorCountByTopic[topic];
          const total = totalAnsweredQuestionsByTopic[topic] || 0;
          if (total > 0) {
            const percent = ((errors / total) * 100).toFixed(1);
            const li = document.createElement('li');
            li.textContent = `${topic}: ${percent}% de erros (${errors} de ${total} quest√µes respondidas)`;
            topicsToReviewList.appendChild(li);
          }
        }
      } else {
        const li = document.createElement('li');
        li.textContent = "ü•≥ Parab√©ns! Voc√™ n√£o teve erros nas quest√µes respondidas.";
        topicsToReviewList.appendChild(li);
      }

      errorDiagnosisSection.style.display = 'block';
      generatedQuestionsSection.style.display = 'block';
      generateNewQuestionsBtn.style.display = 'block';
      scrollToDiagnosis();
    }

    function scrollToQuestion(index) {
      const questionCard = document.getElementById(`question-${index}`);
      if (questionCard) {
        questionCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function scrollToDiagnosis() {
        errorDiagnosisSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function scrollToGeneratedQuestions() {
        generatedQuestionsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Event listener para sele√ß√£o de op√ß√µes (funciona para est√°ticas e din√¢micas)
    document.addEventListener("click", function (event) {
      const clickedElement = event.target;
      const optionElement = clickedElement.closest('.option');

      if (optionElement) {
          if (clickedElement.classList.contains("scissor-icon")) {
              event.stopPropagation();
              optionElement.classList.toggle("struck-through");
          }
          else {
              const parentCard = optionElement.closest('.card');
              const currentQuestionOptions = parentCard.querySelectorAll('.option');

              currentQuestionOptions.forEach(opt => opt.classList.remove("selected"));
              optionElement.classList.add("selected");
          }
      }
    });

    generateNewQuestionsBtn.addEventListener("click", async function() {
        statusMessage.textContent = '‚è≥ Gerando novas perguntas...';
        generateNewQuestionsBtn.disabled = true;

        const topics = Object.keys(errorCountByTopic).filter(topic => {
            const errorsInTopic = errorCountByTopic[topic] || 0;
            const totalAnsweredInTopic = totalAnsweredQuestionsByTopic[topic] || 0;
            return errorsInTopic > 0 && totalAnsweredInTopic > 0;
        });

        const topicsToSend = topics.length > 0 ? topics : ["fisiologia celular", "biologia"];

        try {
            const response = await fetch('https://www.quizia.xyz/quiz', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ topicos: topicsToSend }),
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            newQuestionsContent.innerHTML = '';
            if (data && data.html) {
                console.log('üì• HTML recebido do Flask:', data.html);
                
                // Insere o HTML diretamente sem reconstru√ß√£o complexa
                newQuestionsContent.innerHTML = data.html.replace(/```html|```/g, '');
                
                // Adiciona tesouras e ajusta formata√ß√£o apenas se necess√°rio
                newQuestionsContent.querySelectorAll('.card').forEach((card, cardIndex) => {
                    // Garante que o elemento de pergunta tenha a classe correta
                    const questionElement = card.querySelector('p');
                    if (questionElement && !questionElement.classList.contains('question')) {
                       questionElement.classList.add('question');
                    }

                    // Remove qualquer input de radio que possa existir e adiciona tesouras
                    card.querySelectorAll('label').forEach((label) => {
                        // Remove inputs de radio MAS preserva o atributo data-answer
                        const radioInput = label.querySelector('input[type="radio"]');
                        if (radioInput) {
                            // PRESERVA o atributo data-answer do input no label
                            if (radioInput.hasAttribute('data-answer')) {
                                label.setAttribute('data-answer', radioInput.getAttribute('data-answer'));
                            }
                            radioInput.remove();
                        }
                        
                        // Garante que tenha a classe option
                        if (!label.classList.contains('option')) {
                            label.classList.add('option');
                        }

                        // Garante que tenha data-value
                        if (!label.dataset.value) {
                            label.dataset.value = label.textContent.trim();
                        }

                        // Adiciona tesoura se n√£o existir
                        if (!label.querySelector('.scissor-icon')) {
                            const scissorIcon = document.createElement('img');
                            scissorIcon.src = 'tesouras.png';
                            scissorIcon.className = 'scissor-icon';
                            scissorIcon.onclick = function(e) {
                                e.stopPropagation();
                                label.classList.toggle('struck-through');
                            };
                            label.insertBefore(scissorIcon, label.firstChild);
                        }
                    });

                    console.log(`üè∑Ô∏è Card ${cardIndex}: data-topic = "${card.dataset.topic}"`);
                    
                    // Verifica se h√° op√ß√£o correta marcada
                    const correctOption = card.querySelector('label[data-answer="true"]');
                    if (correctOption) {
                        console.log(`‚úÖ Op√ß√£o correta encontrada: "${correctOption.dataset.value}"`);
                    } else {
                        console.log('‚ùå Nenhuma op√ß√£o correta encontrada');
                    }
                });
            } else {
                newQuestionsContent.innerHTML = "<p>N√£o foi poss√≠vel gerar novas perguntas para os t√≥picos selecionados.</p>";
            }
            
            generatedQuestionsSection.style.display = 'block';
            scrollToGeneratedQuestions();
            statusMessage.textContent = '‚úÖ Perguntas geradas com sucesso!';
            setTimeout(() => { statusMessage.textContent = '' }, 3000);

        } catch (error) {
            console.error('Erro ao gerar novas perguntas:', error);
            newQuestionsContent.innerHTML = `<p>Erro ao carregar novas perguntas: ${error.message}. Por favor, tente novamente.</p>`;
            generatedQuestionsSection.style.display = 'block';
            scrollToGeneratedQuestions();
            statusMessage.textContent = '‚ùå Erro na requisi√ß√£o: ' + error.message;
            setTimeout(() => { statusMessage.textContent = '' }, 5000);
        } finally {
            generateNewQuestionsBtn.disabled = false;
        }
    });

    // Inicializa√ß√£o
    buildQuiz();
    errorDiagnosisSection.style.display = 'none';
    generatedQuestionsSection.style.display = 'none';
    generateNewQuestionsBtn.style.display = 'none';

    // Event listener para o bot√£o de verificar respostas
    document.getElementById("verifyAnswersBtn").addEventListener("click", showResults);
  </script>
  <script src="conexao_firebase.js"></script><script src="navegacao.js"></script><script type="module" src="padrao_simulado.js"></script>

</body>
</html>
