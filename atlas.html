<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>SecondLook Atlas</title>
<style>
body { 
  font-family: Arial, sans-serif; 
  background:#111; 
  color:#eee; 
}

h1 { margin-bottom: 20px; }

h2 { 
  border-bottom:1px solid #444; 
  margin-top: 40px;
}

.row {
  display: flex;
  gap: 20px;
  margin-bottom: 30px;
  align-items: flex-start;
}

.card {
  background: #1b1b1b;
  padding: 10px;
  border-radius: 10px;
  width: 48%;
  text-align: center;
}

.card img {
  max-width: 100%;
  border-radius: 8px;
  margin-bottom: 6px;
}

.label {
  font-size: 13px;
  font-weight: bold;
  margin-bottom: 5px;
}

.label.q { color: #7dd3fc; }
.label.a { color: #86efac; }

.desc {
  font-size: 12px;
  color: #aaa;
  margin-top: 6px;
  line-height: 1.4;
}

.answer-stack img {
  margin-bottom: 10px;
}

.bad-pair {
  border: 1px dashed #f87171;
  background: #2a1212;
}

</style>
</head>
<body>

<h1>SecondLook Histology Atlas</h1>
<div id="atlas"></div>

<script>
fetch('./atlas.json')
  .then(r => r.json())
  .then(data => {

    const root = document.getElementById("atlas");

    const bySystem = {};
    data.forEach(x => {
      if (!bySystem[x.system]) bySystem[x.system] = [];
      bySystem[x.system].push(x);
    });

    const extractNumber = file => {
      const m = file.match(/\((\d+)\)\.webp$/i);
      return m ? parseInt(m[1]) : 0;
    };

    for (const sys in bySystem) {

      const h = document.createElement("h2");
      h.textContent = sys;
      root.appendChild(h);

      const byBase = {};

      bySystem[sys].forEach(x => {
        const base = x.file
          .replace(/\s*\(\d+\)\.webp$/i, "")
          .trim();

        if (!byBase[base]) byBase[base] = [];
        byBase[base].push(x);
      });

      for (const base in byBase) {

        const items = byBase[base]
          .map(x => ({...x, n: extractNumber(x.file)}))
          .sort((a,b) => a.n - b.n);

        if (items.length < 2) continue;

        const question = items[0];

        const answers = items.slice(1).filter(it => {
          const qText = (question.question || "").toLowerCase();
          const aText = (it.question || "").toLowerCase();

          return (
            it.n > question.n &&
            (
              aText.includes(" is ") ||
              aText.includes(" are ") ||
              aText.includes(" the cell") ||
              aText.includes(" surrounded") ||
              aText.includes(" consists") ||
              aText.includes(" composed") ||
              aText.length > qText.length
            )
          );
        });

        const row = document.createElement("div");
        row.className = "row";

        const qCard = document.createElement("div");
        qCard.className = "card";
        qCard.innerHTML = `
          <div class="label q">PERGUNTA</div>
          <img src="./Histologia/Michigan/${question.file}" loading="lazy">
          <div class="desc">${question.question || base}</div>
        `;

        const aCard = document.createElement("div");
        aCard.className = "card";

        let answersHTML = "";

        answers.forEach(it => {
          answersHTML += `
            <img src="./Histologia/Michigan/${it.file}" loading="lazy">
          `;
        });

        if (!answersHTML) {
          aCard.classList.add("bad-pair");
          answersHTML = `<div class="desc">⚠️ Resposta não detectada automaticamente</div>`;
        }

        aCard.innerHTML = `
          <div class="label a">RESPOSTA</div>
          <div class="answer-stack">
            ${answersHTML}
          </div>
        `;

        row.appendChild(qCard);
        row.appendChild(aCard);
        root.appendChild(row);
      }
    }

  })
  .catch(err => {
    document.getElementById("atlas").innerHTML =
      "<p style='color:red'>Erro ao carregar atlas.json</p>";
    console.error(err);
  });
</script>

</body>
</html>
