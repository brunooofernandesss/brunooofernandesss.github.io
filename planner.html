<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner AcadÃªmico | Medicina UNIP</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg-body: #f3f4f6; --bg-white: #ffffff; --border-color: #e5e7eb;
            --text-primary: #111827; --text-secondary: #6b7280;
            --brand-color: #0f172a; --accent-color: #2563eb;
            --success-color: #10b981; --error-color: #ef4444;
            --bg-sidebar: #F7F7F5; --shadow-card: rgba(0,0,0,0.1) 0px 2px 4px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-primary); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* NAVBAR */
        .navbar { background-color: var(--bg-white); border-bottom: 1px solid var(--border-color); padding: 0 32px; height: 64px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; }
        .navbar-brand { font-weight: 700; font-size: 1.125rem; color: var(--brand-color); display: flex; align-items: center; gap: 10px; text-decoration: none; }
        .navbar-brand i { color: var(--accent-color); }
        .user-profile { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 32px; height: 32px; background-color: var(--brand-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: 600; }

        /* LAYOUT & SIDEBAR */
        .app-container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 240px; background: var(--bg-sidebar); border-right: 1px solid var(--border-color); padding: 20px 12px; flex-shrink: 0; }
        .menu a { display: flex; align-items: center; gap: 10px; padding: 10px; color: var(--text-primary); text-decoration: none; border-radius: 6px; font-size: 14px; cursor: pointer; margin-bottom: 4px; transition: 0.2s; }
        .menu a:hover { background: rgba(0,0,0,0.04); }
        .menu a.active { background: rgba(0,0,0,0.08); font-weight: 600; }

        /* CONTENT AREA */
        .main-content { flex: 1; overflow-y: auto; padding: 40px 60px; background-color: var(--bg-white); }
        .page-title { font-size: 1.875rem; font-weight: 700; margin-bottom: 24px; }
        #statusFeedback { padding: 12px; border-radius: 6px; font-size: 13px; font-weight: 500; margin-bottom: 24px; display: none; border: 1px solid transparent; }

        /* KANBAN BOARD */
        .kanban-board { display: flex; gap: 24px; }
        .column { flex: 1; min-width: 250px; }
        .column-title { font-size: 0.875rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; display: flex; justify-content: space-between; }
        .task-container { min-height: 450px; background: #f9fafb; border-radius: 8px; padding: 12px; border: 1px dashed #eee; display: flex; flex-direction: column; gap: 12px; transition: 0.2s; }
        .task-container.drag-over { background: #e0e7ff; border-color: var(--accent-color); }
        
        /* CARD DESIGN */
        .card { background: white; padding: 14px; border-radius: 8px; box-shadow: var(--shadow-card); font-size: 0.875rem; position: relative; border-left: 4px solid transparent; }
        .btn-delete-task { position: absolute; top: 10px; right: 10px; color: #d1d5db; cursor: pointer; transition: 0.2s; }
        .btn-delete-task:hover { color: var(--error-color); }
        .card-tag { font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; margin-top: 8px; display: inline-flex; align-items: center; gap: 4px; }
        .tag-pdf { background: #fee2e2; color: #991b1b; }
        .tag-manual { background: #dcfce7; color: #166534; }

        /* POMODORO UI */
        .pomodoro-box { margin-top: 12px; padding-top: 10px; border-top: 1px solid #f3f4f6; display: flex; align-items: center; justify-content: space-between; }
        .timer-display { font-family: monospace; font-weight: 700; font-size: 14px; }
        .btn-timer { background: none; border: none; cursor: pointer; font-size: 16px; color: var(--text-secondary); }
        .btn-timer.playing { color: var(--success-color); }
        .btn-timer.paused { color: var(--accent-color); }

        /* DASHBOARD */
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px; }
        .stat-card { padding: 24px; background: white; border: 1px solid var(--border-color); border-radius: 12px; text-align: center; }
        .hidden { display: none; }

        /* LIB STYLE */
        .lib-item { padding: 16px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; background: white; }
    </style>
</head>
<body>

    <nav class="navbar">
        <a href="index.html" class="navbar-brand"><i class="fas fa-graduation-cap"></i> Medicina UNIP</a>
        <div class="user-profile">
            <div class="user-info-text">
                <span class="user-name" id="displayUser">Carregando...</span>
            </div>
            <div class="user-avatar" id="userAvatar">U</div>
        </div>
    </nav>

    <div class="app-container">
        <aside class="sidebar">
            <nav class="menu">
                <a id="navBoard" class="active"><i class="fas fa-columns"></i> Board de Estudos</a>
                <a id="navLib"><i class="fas fa-file-pdf"></i> Biblioteca</a>
                <a id="navDash"><i class="fas fa-chart-line"></i> Dashboard</a>
            </nav>
        </aside>

        <main class="main-content">
            <h1 class="page-title" id="pageTitle">Planner Semanal</h1>
            <div id="statusFeedback"></div>

            <section id="secDash" class="hidden">
                <div class="stat-grid">
                    <div class="stat-card"><strong id="dashTime">0h</strong><span>Tempo de Estudo</span></div>
                    <div class="stat-card"><strong id="dashDone">0</strong><span>ConcluÃ­das</span></div>
                    <div class="stat-card"><strong id="dashRate">0%</strong><span>AderÃªncia</span></div>
                </div>
                <div style="background:white; padding:24px; border-radius:12px; border:1px solid var(--border-color);">
                    <canvas id="prodChart" height="100"></canvas>
                </div>
            </section>

            <section id="secBoard">
                <div class="quick-actions" style="display:flex; gap:12px; margin-bottom:32px;">
                    <button id="btnNovoAssunto" class="btn-primary" style="background:var(--accent-color); color:white; border:none; padding:10px 16px; border-radius:6px; cursor:pointer;"><i class="fas fa-plus"></i> Novo Assunto</button>
                    <input type="file" id="pdfInput" hidden accept="application/pdf">
                    <label for="pdfInput" style="border:1px solid var(--border-color); padding:10px 16px; border-radius:6px; cursor:pointer;"><i class="fas fa-cloud-upload-alt"></i> Upload PDF</label>
                </div>
                <div class="kanban-board">
                    <div class="column"><div class="column-title">A Fazer <span id="count-todo">0</span></div><div class="task-container" id="todo" ondrop="drop(event)" ondragover="allowDrop(event)"></div></div>
                    <div class="column"><div class="column-title" style="color:var(--error-color);">RevisÃ£o <span id="count-review">0</span></div><div class="task-container" id="review" ondrop="drop(event)" ondragover="allowDrop(event)"></div></div>
                    <div class="column"><div class="column-title" style="color:var(--success-color);">ConcluÃ­do <span id="count-done">0</span></div><div class="task-container" id="done" ondrop="drop(event)" ondragover="allowDrop(event)"></div></div>
                </div>
            </section>

            <section id="secLib" class="hidden">
                <div id="listaBiblioteca"></div>
            </section>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDj-c4uArNjAr7cSg396yfQR6xuyumh5_M",
            authDomain: "simuladosmedicina-6a01b.firebaseapp.com",
            projectId: "simuladosmedicina-6a01b",
            storageBucket: "simuladosmedicina-6a01b.appspot.com",
            messagingSenderId: "577452734306",
            appId: "1:577452734306:web:5926d087a27a216a97de3b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let currentUID = null;
        let activeTimers = {};
        let myChart = null;

        // --- 1. AUTO-SAVE NO FECHAMENTO ---
        window.addEventListener("beforeunload", async (e) => {
            for (const id in activeTimers) {
                const s = parseInt(document.getElementById(`time-${id}`).dataset.s);
                await updateDoc(doc(db, "planners", currentUID, "tasks", id), { tempoGasto: s });
            }
        });

        onAuthStateChanged(auth, async (user) => {
            if (!user) { window.location.href = "login.html"; return; }
            currentUID = user.uid;
            const snap = await getDoc(doc(db, "usuarios", user.email));
            document.getElementById('displayUser').textContent = snap.exists() ? snap.data().nome : user.email.split("@")[0];
            initListeners();
        });

        function initListeners() {
            onSnapshot(query(collection(db, "planners", currentUID, "tasks"), orderBy("criadoEm", "desc")), (snap) => {
                const tasks = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderBoard(tasks);
                renderDashboard(tasks);
            });

            onSnapshot(query(collection(db, "planners", currentUID, "arquivos"), orderBy("data", "desc")), (snap) => {
                renderLibrary(snap.docs.map(d => ({ id: d.id, ...d.data() })));
            });
        }

        // --- 2. DRAG & DROP INSTANTÃ‚NEO ---
        window.allowDrop = (e) => e.preventDefault();
        window.drop = async (e) => {
            e.preventDefault();
            const id = e.dataTransfer.getData("text");
            const col = e.currentTarget.id;
            // Feedback Visual InstantÃ¢neo
            const card = document.getElementById(id);
            if (card) e.currentTarget.appendChild(card);
            await updateDoc(doc(db, "planners", currentUID, "tasks", id), { column: col });
        };

        // --- 3. POMODORO AUTO-SAVE E UI ---
        window.toggleTimer = async (id) => {
            const btn = document.getElementById(`btn-${id}`);
            const display = document.getElementById(`time-${id}`);
            if (activeTimers[id]) {
                clearInterval(activeTimers[id]);
                delete activeTimers[id];
                btn.innerHTML = '<i class="fas fa-play"></i>';
                btn.className = 'btn-timer paused';
                await saveTime(id, parseInt(display.dataset.s));
            } else {
                btn.innerHTML = '<i class="fas fa-pause"></i>';
                btn.className = 'btn-timer playing';
                activeTimers[id] = setInterval(async () => {
                    display.dataset.s = parseInt(display.dataset.s) + 1;
                    display.innerText = formatTime(display.dataset.s);
                    if (display.dataset.s % 60 === 0) await saveTime(id, parseInt(display.dataset.s));
                }, 1000);
            }
        };

        const saveTime = async (id, s) => await updateDoc(doc(db, "planners", currentUID, "tasks", id), { tempoGasto: s });
        const formatTime = (s) => `${Math.floor(s/3600).toString().padStart(2,'0')}:${Math.floor((s%3600)/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;

        // --- 4. DASHBOARD COM CORES DE META ---
        function renderDashboard(tasks) {
            const metaDiaria = 3; 
            const daysData = [0,0,0,0,0,0,0];
            let totalS = 0, done = 0;

            tasks.forEach(t => {
                totalS += (t.tempoGasto || 0);
                if (t.column === "done") done++;
                if (t.criadoEm) daysData[t.criadoEm.toDate().getDay()] += (t.tempoGasto || 0) / 3600;
            });

            document.getElementById("dashTime").innerText = (totalS/3600).toFixed(1) + "h";
            document.getElementById("dashDone").innerText = done;
            document.getElementById("dashRate").innerText = tasks.length ? Math.round((done/tasks.length)*100) + "%" : "0%";

            const ctx = document.getElementById('prodChart').getContext('2d');
            const achievedColors = daysData.map(h => h >= metaDiaria ? '#10b981' : '#2563eb');

            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ["Dom","Seg","Ter","Qua","Qui","Sex","SÃ¡b"],
                    datasets: [{ label: 'Horas Estudadas', data: daysData, backgroundColor: achievedColors, borderRadius: 6 }]
                },
                options: { plugins: { legend: { display: false } } }
            });
        }

        // --- 5. PERFORMANCE COM DOCUMENTFRAGMENT ---
        function renderBoard(tasks) {
            const cols = { todo: document.getElementById("todo"), review: document.getElementById("review"), done: document.getElementById("done") };
            Object.values(cols).forEach(c => c.innerHTML = "");
            
            const frags = { todo: document.createDocumentFragment(), review: document.createDocumentFragment(), done: document.createDocumentFragment() };
            const counts = { todo: 0, review: 0, done: 0 };

            tasks.forEach(t => {
                counts[t.column]++;
                const card = document.createElement("div");
                card.className = "card"; card.id = t.id; card.draggable = true;
                card.style.borderLeftColor = t.tipo === 'pdf' ? '#ef4444' : '#10b981';
                card.ondragstart = (e) => e.dataTransfer.setData("text", t.id);
                card.innerHTML = `
                    <i class="fas fa-times btn-delete-task" onclick="confirm('Excluir?') && deleteDoc(doc(db,'planners','${currentUID}','tasks','${t.id}'))"></i>
                    <div style="font-weight:600;">${t.titulo}</div>
                    <span class="card-tag ${t.tipo === 'pdf' ? 'tag-pdf' : 'tag-manual'}">
                        ${t.tipo === 'pdf' ? '<i class="fas fa-file-pdf"></i> REVISÃƒO' : '<i class="fas fa-pen"></i> MANUAL'}
                    </span>
                    <div class="pomodoro-box">
                        <div class="timer-display" id="time-${t.id}" data-s="${t.tempoGasto || 0}">${formatTime(t.tempoGasto || 0)}</div>
                        <button onclick="toggleTimer('${t.id}')" id="btn-${t.id}" class="btn-timer paused"><i class="fas fa-play"></i></button>
                    </div>`;
                frags[t.column].appendChild(card);
            });
            
            Object.keys(cols).forEach(k => {
                cols[k].appendChild(frags[k]);
                document.getElementById(`count-${k}`).innerText = counts[k];
            });
        }

        function renderLibrary(files) {
            const container = document.getElementById("listaBiblioteca");
            container.innerHTML = "";
            const frag = document.createDocumentFragment();
            files.forEach(p => {
                const div = document.createElement("div"); div.className = "lib-item";
                div.innerHTML = `<span>ðŸ“„ ${p.nome}</span>
                    <div style="display:flex; gap:10px;">
                        <a href="${p.url}" target="_blank" style="text-decoration:none; color:var(--accent-color); font-weight:600;">Abrir</a>
                        <button onclick="excluirMaterial('${p.id}','${p.fullPath}','${p.nome}')" style="background:none; border:none; color:var(--error-color); cursor:pointer;"><i class="fas fa-trash"></i></button>
                    </div>`;
                frag.appendChild(div);
            });
            container.appendChild(frag);
        }

        // --- ACTIONS ---
        document.getElementById("btnNovoAssunto").onclick = async () => {
            const t = prompt("Assunto:");
            if (t) await addDoc(collection(db, "planners", currentUID, "tasks"), { titulo: t, column: "todo", criadoEm: serverTimestamp(), tipo: "manual", tempoGasto: 0 });
        };

        document.getElementById("pdfInput").onchange = async (e) => {
            const file = e.target.files[0]; if (!file) return;
            const path = `planners/${currentUID}/${Date.now()}_${file.name}`;
            await uploadBytes(ref(storage, path), file);
            const url = await getDownloadURL(ref(storage, path));
            await addDoc(collection(db, "planners", currentUID, "arquivos"), { nome: file.name, url, fullPath: path, data: serverTimestamp() });
            const ciclos = [{ l: "D1", c: "review" }, { l: "D7", c: "todo" }, { l: "D21", c: "todo" }];
            for (const x of ciclos) await addDoc(collection(db, "planners", currentUID, "tasks"), { titulo: `[${x.l}] ${file.name}`, pdfUrl: url, column: x.c, criadoEm: serverTimestamp(), tipo: "pdf", tempoGasto: 0 });
        };

        window.excluirMaterial = async (id, path, name) => {
            if (!confirm(`Excluir material e tarefas vinculadas?`)) return;
            await deleteObject(ref(storage, path));
            await deleteDoc(doc(db, "planners", currentUID, "arquivos", id));
        };

        window.changeView = (v) => {
            document.getElementById("secBoard").classList.toggle("hidden", v !== 'board');
            document.getElementById("secLib").classList.toggle("hidden", v !== 'lib');
            document.getElementById("secDash").classList.toggle("hidden", v !== 'dash');
            document.querySelectorAll(".menu a").forEach(a => a.classList.remove("active"));
            document.getElementById(`nav${v.charAt(0).toUpperCase() + v.slice(1)}`).classList.add("active");
        };
        document.getElementById("navBoard").onclick = () => changeView('board');
        document.getElementById("navLib").onclick = () => changeView('lib');
        document.getElementById("navDash").onclick = () => changeView('dash');
    </script>
</body>
</html>
