<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner de Medicina | Spaced Repetition</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #fbfbfb; --bg-white: #ffffff; --border-color: #e5e7eb;
            --text-primary: #37352f; --text-secondary: #73726e;
            --brand-color: #0f172a; --accent-color: #2383e2; 
            --bg-sidebar: #f7f7f5; --shadow-card: rgba(15, 15, 15, 0.1) 0px 0px 0px 1px, rgba(15, 15, 15, 0.1) 0px 2px 4px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-primary); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* NAVBAR NOTION STYLE */
        .navbar { background-color: var(--bg-white); border-bottom: 1px solid var(--border-color); padding: 0 20px; height: 50px; display: flex; align-items: center; justify-content: space-between; z-index: 1000; }
        
        .app-container { display: flex; flex: 1; overflow: hidden; }
        
        /* SIDEBAR NOTION STYLE */
        .sidebar { width: 240px; background: var(--bg-sidebar); border-right: 1px solid var(--border-color); padding: 20px 12px; display: flex; flex-direction: column; }
        .menu a { display: flex; align-items: center; gap: 8px; padding: 8px; color: var(--text-primary); text-decoration: none; border-radius: 4px; font-size: 14px; margin-bottom: 2px; }
        .menu a:hover { background: rgba(0,0,0,0.04); }
        .menu a.active { background: rgba(0,0,0,0.08); font-weight: 600; }

        .main-content { flex: 1; overflow-y: auto; padding: 40px 60px; background-color: var(--bg-white); }
        .page-title { font-size: 32px; font-weight: 700; margin-bottom: 24px; letter-spacing: -0.02em; }

        /* ACTIONS */
        .quick-actions { display: flex; gap: 12px; margin-bottom: 32px; }
        .btn-notion { border: 1px solid var(--border-color); background: white; padding: 6px 12px; border-radius: 4px; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .btn-notion:hover { background: #f1f1f1; }
        .btn-primary { background: var(--accent-color); color: white; border: none; }

        /* KANBAN BOARD */
        .kanban-board { display: flex; gap: 24px; align-items: flex-start; }
        .column { flex: 1; min-width: 250px; }
        .column-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; font-size: 14px; font-weight: 600; color: var(--text-secondary); }
        .task-container { min-height: 200px; display: flex; flex-direction: column; gap: 12px; }

        /* CARD NOTION STYLE */
        .card { background: white; padding: 12px; border-radius: 4px; box-shadow: var(--shadow-card); cursor: grab; border: 1px solid transparent; transition: background 0.2s; }
        .card:hover { background: #fbfbfb; }
        .pill { padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: 600; margin-top: 8px; display: inline-flex; align-items: center; gap: 4px; }
        .pill-blue { background: rgba(35, 131, 226, 0.1); color: #2383e2; }
        .pill-red { background: rgba(235, 87, 87, 0.1); color: #eb5757; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div style="font-size: 14px; font-weight: 500;"><i class="fas fa-graduation-cap"></i> Medicina UNIP</div>
        <div id="userInfo" style="font-size: 12px; color: var(--text-secondary);">
            <span id="displayUser" style="font-weight: 600;">Carregando...</span>
            <button onclick="logout()" style="margin-left: 10px; border:none; background:none; color: #eb5757; cursor:pointer;">Sair</button>
        </div>
    </nav>

    <div class="app-container">
        <aside class="sidebar">
            <nav class="menu">
                <a href="#" class="active"><i class="fas fa-columns"></i> Board de Estudos</a>
                <a id="menuLibrary"><i class="fas fa-file-pdf"></i> Biblioteca</a>
                <a id="menuStats"><i class="fas fa-chart-line"></i> Dashboard</a>
            </nav>
        </aside>

        <main class="main-content">
            <h1 class="page-title" id="pageTitle">Planner de Estudo</h1>

            <section class="quick-actions">
                <button class="btn-notion btn-primary" id="btnNovaTask"><i class="fas fa-plus"></i> Novo Assunto</button>
                <input type="file" id="pdfInput" hidden onchange="uploadPDF()">
                <label for="pdfInput" class="btn-notion" id="pdfBtnLabel"><i class="fas fa-upload"></i> Upload PDF (D1/D7/D21)</label>
            </section>

            <section class="kanban-board" id="boardArea">
                <div class="column" id="todo" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <div class="column-header">A Fazer <span id="count-todo">0</span></div>
                    <div class="task-container" id="col-todo"></div>
                </div>
                <div class="column" id="review" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <div class="column-header" style="color:#eb5757">Revisão <span id="count-review">0</span></div>
                    <div class="task-container" id="col-review"></div>
                </div>
                <div class="column" id="done" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <div class="column-header" style="color:#4dab9a">Concluído <span id="count-done">0</span></div>
                    <div class="task-container" id="col-done"></div>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDj-c4uArNjAr7cSg396yfQR6xuyumh5_M",
            authDomain: "simuladosmedicina-6a01b.firebaseapp.com",
            projectId: "simuladosmedicina-6a01b",
            storageBucket: "simuladosmedicina-6a01b.firebasestorage.app",
            messagingSenderId: "577452734306",
            appId: "1:577452734306:web:5926d087a27a216a97de3b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let userUID = null;
        let tasks = [];

        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "login.html";
            else {
                userUID = user.uid;
                document.getElementById('displayUser').textContent = user.email;
                carregarTasks();
            }
        });

        window.logout = () => signOut(auth);

        // FUNÇÃO DE TAREFA MANUAL
        document.getElementById("btnNovaTask").onclick = async () => {
            const title = prompt("Qual assunto você vai estudar hoje?");
            if (title && userUID) {
                await addDoc(collection(db, "planners", userUID, "tasks"), {
                    title: title, column: "todo", createdAt: serverTimestamp()
                });
                carregarTasks();
            }
        };

        // UPLOAD COM CICLO COGNITIVO (D1, D7, D21)
        window.uploadPDF = async function() {
            const file = document.getElementById("pdfInput").files[0];
            const btnLabel = document.getElementById("pdfBtnLabel");
            if (!file || !userUID) return;

            try {
                btnLabel.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Agendando ciclos...`;
                const storageRef = ref(storage, `planners/${userUID}/arquivos/${Date.now()}_${file.name}`);
                await uploadBytes(storageRef, file);
                const url = await getDownloadURL(storageRef);

                // Criar D1 (Amanhã), D7 (Semana que vem), D21 (Mês que vem)
                const intervalos = [
                    { label: "D1", dias: 1, col: "review" },
                    { label: "D7", dias: 7, col: "todo" },
                    { label: "D21", dias: 21, col: "todo" }
                ];

                for (const i of intervalos) {
                    await addDoc(collection(db, "planners", userUID, "tasks"), {
                        title: `[${i.label}] ${file.name}`,
                        column: i.col, pdf: url, type: i.label, createdAt: serverTimestamp()
                    });
                }
                btnLabel.innerHTML = `<i class="fas fa-upload"></i> Upload Concluído!`;
                carregarTasks();
            } catch (e) { console.error(e); }
        };

        async function carregarTasks() {
            if (!userUID) return;
            const snap = await getDocs(collection(db, "planners", userUID, "tasks"));
            tasks = [];
            snap.forEach(d => tasks.push({ id: d.id, ...d.data() }));
            renderBoard();
        }

        function renderBoard() {
            ['todo', 'review', 'done'].forEach(colId => {
                const container = document.getElementById(`col-${colId}`);
                container.innerHTML = '';
                const filtered = tasks.filter(t => t.column === colId);
                filtered.forEach(t => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.draggable = true;
                    card.id = t.id;
                    card.innerHTML = `
                        <div style="font-size:14px; line-height:1.5;">${t.title}</div>
                        ${t.pdf ? `<span class="pill pill-red"><i class="far fa-file-pdf"></i> Material</span>` : ''}
                        ${t.type ? `<span class="pill pill-blue"><i class="fas fa-brain"></i> ${t.type}</span>` : ''}
                    `;
                    card.addEventListener('dragstart', e => e.dataTransfer.setData("text", e.target.id));
                    container.appendChild(card);
                });
                document.getElementById(`count-${colId}`).textContent = filtered.length;
            });
        }

        window.allowDrop = e => e.preventDefault();
        window.drop = async e => {
            e.preventDefault();
            const id = e.dataTransfer.getData("text");
            const col = e.target.closest('.column');
            if (id && col) {
                await updateDoc(doc(db, "planners", userUID, "tasks", id), { column: col.id });
                carregarTasks();
            }
        };
    </script>
</body>
</html>
