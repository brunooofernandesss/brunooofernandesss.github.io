<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medicina UNIP | Notion Planner Ultimate</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --notion-bg: #ffffff;
            --notion-sidebar: #fbfbfa;
            --notion-text: #37352f;
            --notion-text-light: rgba(55, 53, 47, 0.65);
            --notion-border: rgba(55, 53, 47, 0.12);
            --notion-hover: rgba(55, 53, 47, 0.05);
            --notion-blue: #2383e2;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--notion-bg); color: var(--notion-text); display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar */
        .sidebar { width: 240px; background: var(--notion-sidebar); border-right: 1px solid var(--notion-border); display: flex; flex-direction: column; padding: 12px 0; flex-shrink: 0; }
        .sidebar-header { padding: 0 16px 16px; font-weight: 700; font-size: 14px; border-bottom: 1px solid var(--notion-border); margin-bottom: 12px; }
        .nav-item { padding: 8px 16px; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; color: var(--notion-text-light); transition: 0.2s; }
        .nav-item:hover { background: var(--notion-hover); color: var(--notion-text); }
        .nav-item.active { background: var(--notion-hover); font-weight: 600; color: var(--notion-text); }

        /* Layout */
        .main-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { height: 45px; padding: 0 16px; display: flex; align-items: center; justify-content: space-between; font-size: 12px; border-bottom: 1px solid var(--notion-border); color: var(--notion-text-light); }
        .content { flex: 1; overflow-x: auto; padding: 30px; display: flex; flex-direction: column; }
        .page-title { font-size: 30px; font-weight: 700; margin-bottom: 20px; letter-spacing: -0.5px; }

        /* Board Kanban */
        .board { display: flex; gap: 14px; flex: 1; min-width: 1300px; }
        .column { flex: 1; min-width: 250px; display: flex; flex-direction: column; }
        .column-header { padding: 8px; font-size: 13px; font-weight: 600; color: var(--notion-text-light); display: flex; align-items: center; gap: 6px; }
        .drop-zone { flex: 1; overflow-y: auto; padding-right: 4px; border-radius: 4px; }

        .card {
            background: white; border: 1px solid var(--notion-border); border-radius: 6px;
            padding: 12px; margin-bottom: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.04);
            cursor: pointer; transition: 0.2s;
        }
        .card:hover { border-color: #aaa; transform: translateY(-1px); }
        .tag { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; background: #e3e2e0; margin-top: 8px; display: inline-block; }

        /* Modais */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 90%; max-width: 1000px; height: 90vh; border-radius: 8px; padding: 25px; display: flex; flex-direction: column; gap: 15px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        
        /* Editor Customizado */
        .editor-wrapper { flex: 1; overflow-y: auto; border: 1px solid #ccc; border-radius: 4px; display: flex; flex-direction: column; }
        #quill-editor { flex: 1; font-size: 16px; font-family: 'Inter', sans-serif; }
        
        /* Estiliza√ß√£o de Tabelas e Markdown no Editor */
        .ql-editor table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .ql-editor th, .ql-editor td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        .ql-editor th { background-color: #f9f9f9; font-weight: 600; }
        .ql-editor blockquote { border-left: 4px solid #ccc; padding-left: 10px; color: #666; font-style: italic; background: #f9f9f9; padding: 10px; }

        .input-notion { border: 1px solid var(--notion-border); border-radius: 4px; width: 100%; padding: 10px; font-size: 14px; outline: none; }
        .btn-blue { background: var(--notion-blue); color: white; border: none; padding: 10px 20px; border-radius: 4px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-notion { border: 1px solid var(--notion-border); background: white; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
        .btn-notion:hover { background: var(--notion-hover); }

        #pdfViewer { width: 100%; height: 100%; border: none; border-radius: 4px; }
        #statusFeedback { 
            position: fixed; bottom: 30px; right: 30px; 
            background: #2eaadc; color: white; 
            padding: 15px 25px; border-radius: 8px; 
            font-size: 14px; font-weight: 600; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none; z-index: 9999;
        }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="modal" id="modalEditor">
        <div class="modal-content">
            <h3 style="margin-bottom: 5px;">Editor de Conte√∫do</h3>
            <div style="background:#eef6ff; padding:10px; border-radius:5px; font-size:12px; color:#2383e2; margin-bottom:10px;">
                <i class="fas fa-info-circle"></i> Otimizado para Gemini: Copie e cole diretamente. Formata√ß√µes antigas ser√£o corrigidas automaticamente.
            </div>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="subjectTitle" class="input-notion" placeholder="T√≠tulo do Assunto (Obrigat√≥rio)...">
                <input type="text" id="subjectTag" class="input-notion" style="width: 200px;" placeholder="Tag (Ex: GINECOLOGIA)">
            </div>
            
            <div class="editor-wrapper">
                <div id="quill-editor"></div>
            </div>

            <div style="display:flex; justify-content: flex-end; gap: 10px;">
                <button class="btn-notion" onclick="fecharModal()">Cancelar</button>
                <button class="btn-blue" id="btnSalvar">Salvar no Planner</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modalView">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 id="viewTitle" style="font-size: 22px; font-weight:700;"></h2>
                <span id="viewTagDisplay" class="tag"></span>
            </div>
            <div id="viewContainer" style="flex:1; overflow:hidden; border: 1px solid #eee; border-radius: 6px;"></div>
            <div style="display:flex; justify-content: space-between; margin-top:10px;">
                <button class="btn-notion" id="btnEditarNota"><i class="fas fa-edit"></i> Editar Texto</button>
                <button class="btn-notion" onclick="fecharModalView()">Fechar</button>
            </div>
        </div>
    </div>

    <div id="statusFeedback">
        <i class="fas fa-spinner fa-spin"></i> <span id="feedbackText">Processando...</span>
    </div>

    <aside class="sidebar">
        <div class="sidebar-header"><i class="fas fa-graduation-cap"></i> Medicina UNIP</div>
        <div class="nav-item active" id="navBoard"><i class="fas fa-columns"></i> Board de Ciclos</div>
        <div class="nav-item" id="navLib"><i class="fas fa-book"></i> Biblioteca</div>
    </aside>

    <main class="main-container">
        <div class="top-bar">
            <div>Medicina / Ciclos de Estudo</div>
            <div style="display:flex; gap: 15px; align-items:center;">
                <span id="displayIp" style="opacity: 0.5">0.0.0.0</span>
                <b id="displayUser">...</b>
                <div style="width:24px; height:24px; background:#efefef; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:bold;" id="userAvatar">?</div>
            </div>
        </div>

        <div class="content">
            <h1 class="page-title">Planner de Estudos</h1>
            <div style="display:flex; gap: 10px; margin-bottom: 25px;">
                <button class="btn-notion" id="btnNovoAssunto"><i class="fas fa-plus"></i> + Novo Assunto</button>
                <input type="file" id="pdfInput" hidden accept="application/pdf">
                <label for="pdfInput" class="btn-notion" style="cursor:pointer;"><i class="fas fa-file-upload"></i> Subir PDF</label>
            </div>
            <section id="secBoard">
                <div class="board">
                    <div class="column"><div class="column-header">‚ö™ Recentes</div><div class="drop-zone" id="recent" ondrop="drop(event)" ondragover="allowDrop(event)"></div></div>
                    <div class="column"><div class="column-header">üîµ Revisar D+1</div><div class="drop-zone" id="d1" ondrop="drop(event)" ondragover="allowDrop(event)"></div></div>
                    <div class="column"><div class="column-header">üü° Revisar D+7</div><div class="drop-zone" id="d7" ondrop="drop(event)" ondragover="allowDrop(event)"></div></div>
                    <div class="column"><div class="column-header">üî¥ Revisar D+21</div><div class="drop-zone" id="d21" ondrop="drop(event)" ondragover="allowDrop(event)"></div></div>
                    <div class="column"><div class="column-header">üü¢ Conclu√≠do</div><div class="drop-zone" id="done" ondrop="drop(event)" ondragover="allowDrop(event)"></div></div>
                </div>
            </section>
            <section id="secLib" class="hidden">
                <table style="width:100%; border-collapse:collapse; font-size:14px;">
                    <thead><tr style="border-bottom: 1px solid #ddd; text-align:left;"><th style="padding:10px;">Item</th><th style="padding:10px;">Tag</th><th style="padding:10px;">A√ß√£o</th></tr></thead>
                    <tbody id="listaBiblioteca"></tbody>
                </table>
            </section>
        </div>
    </main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDj-c4uArNjAr7cSg396yfQR6xuyumh5_M",
        authDomain: "simuladosmedicina-6a01b.firebaseapp.com",
        projectId: "simuladosmedicina-6a01b",
        storageBucket: "simuladosmedicina-6a01b.firebasestorage.app",
        messagingSenderId: "577452734306",
        appId: "1:577452734306:web:5926d087a27a216a97de3b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentUID = null;
    let editingDocId = null;

    // -----------------------------------------------------
    // 1. CONFIGURA√á√ÉO "WORD COMPLETO" (Com Indenta√ß√£o e Blockquote)
    // -----------------------------------------------------
    const quill = new Quill('#quill-editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'indent': '-1'}, { 'indent': '+1' }], // Adicionado: Indenta√ß√£o
                ['link', 'blockquote', 'code-block'],    // Adicionado: Blockquote
                [{ 'align': [] }],
                ['clean']
            ]
        }
    });

    // -----------------------------------------------------
    // 2. FUN√á√ÉO DE NORMALIZA√á√ÉO (CORRE√á√ÉO DE LEGADO)
    // -----------------------------------------------------
    function normalizeContent(content) {
        if (!content) return '';
        // Se j√° for HTML v√°lido (come√ßa com tag), retorna direto
        if (content.trim().startsWith('<')) {
            return content;
        }
        // Converte Markdown b√°sico para HTML (Legado)
        let html = content
            .replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/## (.*?)\n/g, '<h2>$1</h2>') // T√≠tulos b√°sicos
            .replace(/\n/g, '<br>');
        return html;
    }

    // Interceptador de Colagem (Para novos colares do Gemini)
    quill.root.addEventListener('paste', (e) => {
        const clipboardData = e.clipboardData || window.clipboardData;
        const pastedData = clipboardData.getData('text');

        // Se detectar Markdown forte, converte
        if (pastedData.includes('**') || pastedData.includes('##') || pastedData.includes('|') || pastedData.includes('* ')) {
            e.preventDefault();
            const html = marked.parse(pastedData, { breaks: true, gfm: true });
            const range = quill.getSelection();
            if (range) {
                quill.clipboard.dangerouslyPasteHTML(range.index, html);
            } else {
                quill.clipboard.dangerouslyPasteHTML(0, html);
            }
        }
    });

    window.showFeedback = (msg, isLoading = true) => {
        const el = document.getElementById("statusFeedback");
        const txt = document.getElementById("feedbackText");
        const icon = el.querySelector("i");
        txt.textContent = msg; el.style.display = "block";
        if (isLoading) {
            icon.className = "fas fa-spinner fa-spin"; el.style.backgroundColor = "#2eaadc";
        } else {
            icon.className = "fas fa-check-circle"; el.style.backgroundColor = "#27ae60";
            setTimeout(() => { el.style.display = "none"; }, 4000);
        }
    };

    // Modais e Navega√ß√£o
    const modalEditor = document.getElementById('modalEditor');
    const modalView = document.getElementById('modalView');

    window.fecharModal = () => { modalEditor.style.display = 'none'; editingDocId = null; quill.setContents([]); };
    window.fecharModalView = () => { modalView.style.display = 'none'; document.getElementById('viewContainer').innerHTML = ''; };

    document.getElementById('btnNovoAssunto').onclick = () => {
        document.getElementById('subjectTitle').value = "";
        document.getElementById('subjectTag').value = "";
        modalEditor.style.display = 'flex';
    };

    onAuthStateChanged(auth, (user) => {
        if (!user) { window.location.href = "login.html"; return; }
        currentUID = user.uid;
        document.getElementById("displayUser").textContent = user.email.split("@")[0];
        document.getElementById("userAvatar").textContent = user.email[0].toUpperCase();
        fetch('https://api.ipify.org?format=json').then(r => r.json()).then(d => document.getElementById('displayIp').textContent = d.ip);
        carregarBoard();
    });

    // Salvar no Firestore
    document.getElementById('btnSalvar').onclick = async () => {
        const title = document.getElementById('subjectTitle').value;
        const tag = document.getElementById('subjectTag').value || "GERAL";
        const content = quill.root.innerHTML;

        if (!title) return alert("Preencha o t√≠tulo!");

        showFeedback("Salvando...", true);
        
        try {
            if (editingDocId) {
                await updateDoc(doc(db, "planners", currentUID, "tasks", editingDocId), { titulo: title, tag: tag.toUpperCase(), content: content });
            } else {
                const now = Date.now();
                const ciclos = [
                    { n: `[REC] ${title}`, t: now, col: 'recent' },
                    { n: `[D+1] ${title}`, t: now + 86400000, col: 'd1' },
                    { n: `[D+7] ${title}`, t: now + 604800000, col: 'd7' },
                    { n: `[D+21] ${title}`, t: now + 1814400000, col: 'd21' }
                ];

                for (const c of ciclos) {
                    await addDoc(collection(db, "planners", currentUID, "tasks"), {
                        titulo: c.n, tag: tag.toUpperCase(), content: content, 
                        targetDate: c.t, column: c.col, criadoEm: serverTimestamp(), tipo: 'texto'
                    });
                }
                await addDoc(collection(db, "planners", currentUID, "arquivos"), { 
                    nome: title, content: content, tag: tag.toUpperCase(), data: now, tipo: 'texto' 
                });
            }
            showFeedback("Salvo com sucesso!", false);
            fecharModal();
            carregarBoard();
        } catch (e) { console.error(e); showFeedback("Erro ao salvar.", false); }
    };

    // Upload PDF
    document.getElementById("pdfInput").onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const tag = prompt("Tag do PDF:", "GERAL") || "GERAL";
        showFeedback("Enviando PDF...", true);

        try {
            const refS = ref(storage, `planners/${currentUID}/${Date.now()}_${file.name}`);
            await uploadBytes(refS, file);
            const url = await getDownloadURL(refS);
            const now = Date.now();
            
            const ciclos = [
                { n: `[REC] ${file.name}`, t: now, col: 'recent' }, 
                { n: `[D+1] ${file.name}`, t: now + 86400000, col: 'd1' }, 
                { n: `[D+7] ${file.name}`, t: now + 604800000, col: 'd7' }, 
                { n: `[D+21] ${file.name}`, t: now + 1814400000, col: 'd21' }
            ];
            
            for(const c of ciclos) {
                await addDoc(collection(db, "planners", currentUID, "tasks"), { 
                    titulo: c.n, tag: tag.toUpperCase(), pdfUrl: url, targetDate: c.t, 
                    column: c.col, criadoEm: serverTimestamp(), tipo: 'pdf' 
                });
            }
            await addDoc(collection(db, "planners", currentUID, "arquivos"), { nome: file.name, url, tag: tag.toUpperCase(), data: now, tipo: 'pdf' });
            showFeedback("Sucesso!", false);
            carregarBoard();
        } catch (err) { showFeedback("Erro no upload.", false); }
    };

    // -----------------------------------------------------
    // 3. ABRIR ITEM (COM FALLBACK E NORMALIZA√á√ÉO)
    // -----------------------------------------------------
    window.abrirItem = async (id) => {
        const d = await getDoc(doc(db, "planners", currentUID, "tasks", id));
        if(!d.exists()) return;
        const data = d.data();
        
        document.getElementById('viewTitle').textContent = data.titulo;
        document.getElementById('viewTagDisplay').textContent = data.tag || "GERAL";
        const container = document.getElementById('viewContainer');
        const btnEdit = document.getElementById('btnEditarNota');

        if (data.pdfUrl) {
            container.innerHTML = `<iframe src="${data.pdfUrl}" id="pdfViewer"></iframe>`;
            btnEdit.style.display = 'none';
        } else {
            // AQUI EST√Å A CORRE√á√ÉO PRINCIPAL:
            // 1. Busca qualquer campo poss√≠vel (htmlContent, content, textContent)
            const rawContent = data.htmlContent || data.content || data.textContent || '';
            
            // 2. Normaliza (Markdown -> HTML) se necess√°rio
            const finalHtml = normalizeContent(rawContent);
            
            container.innerHTML = `<div class="ql-editor" style="padding:20px;">${finalHtml}</div>`;
            btnEdit.style.display = 'block';
            
            btnEdit.onclick = () => {
                editingDocId = id;
                document.getElementById('subjectTitle').value = data.titulo.replace(/\[.*?\] /, '');
                document.getElementById('subjectTag').value = data.tag;
                
                // Carrega no editor tamb√©m normalizado
                quill.root.innerHTML = finalHtml;
                
                fecharModalView();
                modalEditor.style.display = 'flex';
            };
        }
        modalView.style.display = 'flex';
    };

    async function carregarBoard() {
        if (!currentUID) return;
        const snap = await getDocs(query(collection(db, "planners", currentUID, "tasks"), orderBy("criadoEm", "desc")));
        const cols = { recent: document.getElementById("recent"), d1: document.getElementById("d1"), d7: document.getElementById("d7"), d21: document.getElementById("d21"), done: document.getElementById("done") };
        Object.values(cols).forEach(c => c.innerHTML = "");
        const agora = Date.now();

        snap.forEach(d => {
            const t = d.data();
            if (t.column !== 'done' && agora < t.targetDate) return;
            const card = document.createElement("div");
            card.className = "card"; card.draggable = true; card.id = d.id;
            card.onclick = () => abrirItem(d.id);
            card.ondragstart = (e) => e.dataTransfer.setData("text", e.target.id);
            card.innerHTML = `<div style="font-weight:600; font-size:13px; margin-bottom:5px;">${t.titulo}</div><span class="tag">${t.tag}</span>`;
            if (cols[t.column]) cols[t.column].appendChild(card);
        });
    }

    // Drag & Drop
    window.allowDrop = (e) => e.preventDefault();
    window.drop = async (e) => {
        e.preventDefault();
        const id = e.dataTransfer.getData("text");
        const col = e.currentTarget.id;
        if(col) { await updateDoc(doc(db, "planners", currentUID, "tasks", id), { column: col }); carregarBoard(); }
    };

    document.getElementById('navBoard').onclick = () => { document.getElementById('secBoard').classList.remove('hidden'); document.getElementById('secLib').classList.add('hidden'); };
    document.getElementById('navLib').onclick = () => { document.getElementById('secBoard').classList.add('hidden'); document.getElementById('secLib').classList.remove('hidden'); carregarBiblioteca(); };

    async function carregarBiblioteca() {
        const snap = await getDocs(query(collection(db, "planners", currentUID, "arquivos"), orderBy("data", "desc")));
        const body = document.getElementById("listaBiblioteca");
        body.innerHTML = "";
        snap.forEach(d => {
            const p = d.data();
            body.innerHTML += `<tr style="border-bottom:1px solid #eee;">
                <td style="padding:10px;">${p.nome}</td>
                <td><span class="tag">${p.tag}</span></td>
                <td><button class="btn-notion" onclick="alert('Visualize pelo Board')">Ver</button></td>
            </tr>`;
        });
    }
</script>
</body>
</html>
