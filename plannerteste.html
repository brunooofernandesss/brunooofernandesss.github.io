<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medicina UNIP | Notion Planner Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --notion-bg: #ffffff;
            --notion-sidebar: #fbfbfa;
            --notion-text: #37352f;
            --notion-text-light: rgba(55, 53, 47, 0.65);
            --notion-border: rgba(55, 53, 47, 0.12);
            --notion-hover: rgba(55, 53, 47, 0.05);
            --notion-blue: #2383e2;
            --tag-bg: #e3e2e0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--notion-bg); color: var(--notion-text); display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar & Layout */
        .sidebar { width: 220px; background: var(--notion-sidebar); border-right: 1px solid var(--notion-border); display: flex; flex-direction: column; padding: 12px 0; flex-shrink: 0; }
        .sidebar-header { padding: 0 16px 16px; font-weight: 700; font-size: 14px; border-bottom: 1px solid var(--notion-border); margin-bottom: 12px; }
        .nav-item { padding: 8px 16px; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; color: var(--notion-text-light); }
        .nav-item:hover { background: var(--notion-hover); color: var(--notion-text); }
        .nav-item.active { background: var(--notion-hover); font-weight: 600; color: var(--notion-text); }

        .main-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { height: 45px; padding: 0 16px; display: flex; align-items: center; justify-content: space-between; font-size: 12px; border-bottom: 1px solid var(--notion-border); color: var(--notion-text-light); }

        .content { flex: 1; overflow-x: auto; padding: 40px; display: flex; flex-direction: column; }
        .page-title { font-size: 32px; font-weight: 700; margin-bottom: 24px; letter-spacing: -0.5px; }

        /* Board */
        .board { display: flex; gap: 16px; flex: 1; min-width: 1250px; }
        .column { flex: 1; min-width: 240px; display: flex; flex-direction: column; }
        .column-header { padding: 8px; font-size: 13px; font-weight: 600; color: var(--notion-text-light); display: flex; align-items: center; gap: 6px; }
        .drop-zone { flex: 1; overflow-y: auto; padding-right: 4px; }

        /* Card */
        .card {
            background: white; border: 1px solid var(--notion-border); border-radius: 6px;
            padding: 12px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            cursor: pointer; transition: 0.2s; position: relative;
        }
        .card:hover { border-color: #bbb; }
        .tag { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; background: var(--tag-bg); margin-top: 8px; display: inline-block; }

        /* Modal Novo Assunto */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 600px; max-height: 85vh; border-radius: 8px; padding: 32px; display: flex; flex-direction: column; gap: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .input-notion { border: none; outline: none; width: 100%; padding: 8px 0; border-bottom: 1px solid var(--notion-border); font-size: 14px; }
        #editorContent { 
            flex: 1; min-height: 200px; overflow-y: auto; border: 1px solid var(--notion-border); 
            padding: 12px; border-radius: 4px; outline: none; font-size: 14px; line-height: 1.6;
        }
        #editorContent h1, #editorContent h2 { margin-bottom: 10px; }

        .btn-blue { background: var(--notion-blue); color: white; border: none; padding: 8px 16px; border-radius: 4px; font-weight: 600; cursor: pointer; }
        .btn-notion { border: 1px solid var(--notion-border); background: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px; }

        /* Estilos de Rich Text dentro das notas */
        .rich-text b { font-weight: 700; }
        .rich-text i { font-style: italic; }

        #statusFeedback { position: fixed; bottom: 20px; right: 20px; background: #37352f; color: white; padding: 12px 24px; border-radius: 6px; font-size: 13px; display: none; z-index: 3000; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="modal" id="modalNovo">
        <div class="modal-content">
            <h2 style="font-size: 20px;">Novo Assunto (Resumo Gemini)</h2>
            <input type="text" id="subjectTitle" class="input-notion" placeholder="TÃ­tulo do Assunto (Ex: Embriologia)">
            <input type="text" id="subjectTag" class="input-notion" placeholder="Tag (Ex: GINECOLOGIA)">
            <div id="editorContent" contenteditable="true" placeholder="Cole aqui o texto do Gemini..."></div>
            <div style="display:flex; justify-content: flex-end; gap: 10px;">
                <button class="btn-notion" onclick="fecharModal()">Cancelar</button>
                <button class="btn-blue" id="btnSalvarAssunto">Criar Ciclo de Estudo</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modalView">
        <div class="modal-content">
            <h2 id="viewTitle" style="font-size: 24px; margin-bottom: 5px;"></h2>
            <div id="viewTag" style="margin-bottom: 15px;"></div>
            <div id="viewBody" class="rich-text" style="overflow-y: auto; flex: 1;"></div>
            <button class="btn-notion" style="align-self: flex-end" onclick="fecharModalView()">Fechar</button>
        </div>
    </div>

    <aside class="sidebar">
        <div class="sidebar-header"><i class="fas fa-graduation-cap"></i> Medicina UNIP</div>
        <div class="nav-item active" id="navBoard"><i class="fas fa-columns"></i> Board de Ciclos</div>
        <div class="nav-item" id="navLib"><i class="fas fa-book"></i> Biblioteca</div>
    </aside>

    <main class="main-container">
        <div class="top-bar">
            <div>Medicina / Ciclos de Estudo</div>
            <div style="display:flex; gap: 15px; align-items:center;">
                <span id="displayIp" style="opacity: 0.5">0.0.0.0</span>
                <div style="display:flex; align-items:center; gap:8px;">
                    <b id="displayUser">...</b>
                    <div style="width:24px; height:24px; background:#efefef; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:bold;" id="userAvatar">?</div>
                </div>
            </div>
        </div>

        <div class="content">
            <h1 class="page-title">Planner de Estudos</h1>
            
            <div style="display:flex; gap: 10px; margin-bottom: 30px;">
                <button class="btn-notion" id="btnAbrirModal"><i class="fas fa-plus"></i> + Novo Assunto</button>
                <input type="file" id="pdfInput" hidden accept="application/pdf">
                <label for="pdfInput" class="btn-notion" style="cursor:pointer;"><i class="fas fa-file-upload"></i> Subir PDF</label>
            </div>

            <section id="secBoard">
                <div class="board">
                    <div class="column"><div class="column-header">âšª Recentes</div><div class="drop-zone" id="recent" ondrop="drop(event)" ondragover="allowDrop(event)"></div></div>
                    <div class="column"><div class="column-header">ðŸ”µ Revisar D+1</div><div class="drop-zone" id="d1" ondrop="drop(event)" ondragover="allowDrop(event)"></div></div>
                    <div class="column"><div class="column-header">ðŸŸ¡ Revisar D+7</div><div class="drop-zone" id="d7" ondrop="drop(event)" ondragover="allowDrop(event)"></div></div>
                    <div class="column"><div class="column-header">ðŸ”´ Revisar D+21</div><div class="drop-zone" id="d21" ondrop="drop(event)" ondragover="allowDrop(event)"></div></div>
                    <div class="column"><div class="column-header">ðŸŸ¢ ConcluÃ­do</div><div class="drop-zone" id="done" ondrop="drop(event)" ondragover="allowDrop(event)"></div></div>
                </div>
            </section>

            <section id="secLib" class="hidden">
                <table class="notion-table" style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <thead><tr style="border-bottom: 1px solid #ddd; text-align: left;"><th style="padding: 10px;">Arquivo/Assunto</th><th style="padding: 10px;">Tag</th><th style="padding: 10px;">AÃ§Ã£o</th></tr></thead>
                    <tbody id="listaBiblioteca"></tbody>
                </table>
            </section>
        </div>
    </main>

    <div id="statusFeedback">Processando...</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDj-c4uArNjAr7cSg396yfQR6xuyumh5_M",
        authDomain: "simuladosmedicina-6a01b.firebaseapp.com",
        projectId: "simuladosmedicina-6a01b",
        storageBucket: "simuladosmedicina-6a01b.firebasestorage.app",
        messagingSenderId: "577452734306",
        appId: "1:577452734306:web:5926d087a27a216a97de3b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentUID = null;

    // Modais
    window.fecharModal = () => document.getElementById('modalNovo').style.display = 'none';
    window.fecharModalView = () => document.getElementById('modalView').style.display = 'none';
    document.getElementById('btnAbrirModal').onclick = () => document.getElementById('modalNovo').style.display = 'flex';

    const showFeedback = (msg) => {
        const el = document.getElementById("statusFeedback");
        el.textContent = msg; el.style.display = "block";
        setTimeout(() => el.style.display = "none", 3000);
    };

    onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "login.html"; return; }
        currentUID = user.uid;
        document.getElementById("displayUser").textContent = user.email.split("@")[0];
        document.getElementById("userAvatar").textContent = user.email[0].toUpperCase();
        fetch('https://api.ipify.org?format=json').then(r => r.json()).then(d => document.getElementById('displayIp').textContent = d.ip);
        carregarBoard();
        carregarBiblioteca();
    });

    // LÃ³gica para Salvar Novo Assunto (Rich Text)
    document.getElementById('btnSalvarAssunto').onclick = async () => {
        const title = document.getElementById('subjectTitle').value;
        const tag = document.getElementById('subjectTag').value || "GERAL";
        const content = document.getElementById('editorContent').innerHTML;

        if (!title || !content) { alert("Preencha o tÃ­tulo e o conteÃºdo!"); return; }

        fecharModal();
        showFeedback("Criando ciclos de repetiÃ§Ã£o...");

        const now = Date.now();
        
        // Salva na biblioteca
        await addDoc(collection(db, "planners", currentUID, "arquivos"), {
            nome: title, content: content, tag: tag.toUpperCase(), data: now, tipo: 'texto'
        });

        // Cria os 4 Ciclos
        const ciclos = [
            { n: `[IMEDIATO] ${title}`, t: now, col: 'recent' },
            { n: `[D+1] ${title}`, t: now + (1*24*60*60*1000), col: 'd1' },
            { n: `[D+7] ${title}`, t: now + (7*24*60*60*1000), col: 'd7' },
            { n: `[D+21] ${title}`, t: now + (21*24*60*60*1000), col: 'd21' }
        ];

        for (const c of ciclos) {
            await addDoc(collection(db, "planners", currentUID, "tasks"), {
                titulo: c.n, tag: tag.toUpperCase(), content: content, targetDate: c.t, column: c.col, criadoEm: serverTimestamp()
            });
        }

        document.getElementById('subjectTitle').value = "";
        document.getElementById('editorContent').innerHTML = "";
        carregarBoard();
    };

    // Upload PDF (Mantendo os 4 ciclos tambÃ©m)
    document.getElementById("pdfInput").onchange = async (e) => {
        const file = e.target.files[0];
        const tag = prompt("Tag do PDF:", "GERAL") || "GERAL";
        showFeedback("Subindo PDF...");
        const storageRef = ref(storage, `planners/${currentUID}/${Date.now()}_${file.name}`);
        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);
        const now = Date.now();

        await addDoc(collection(db, "planners", currentUID, "arquivos"), { nome: file.name, url, tag: tag.toUpperCase(), data: now, tipo: 'pdf' });
        
        const ciclos = [
            { n: `[IMEDIATO] ${file.name}`, t: now, col: 'recent' },
            { n: `[D+1] ${file.name}`, t: now + (1*24*60*60*1000), col: 'd1' },
            { n: `[D+7] ${file.name}`, t: now + (7*24*60*60*1000), col: 'd7' },
            { n: `[D+21] ${file.name}`, t: now + (21*24*60*60*1000), col: 'd21' }
        ];

        for (const c of ciclos) {
            await addDoc(collection(db, "planners", currentUID, "tasks"), {
                titulo: c.n, tag: tag.toUpperCase(), pdfUrl: url, targetDate: c.t, column: c.col, criadoEm: serverTimestamp()
            });
        }
        carregarBoard();
    };

    window.abrirNota = (title, tag, body) => {
        document.getElementById('viewTitle').textContent = title;
        document.getElementById('viewTag').innerHTML = `<span class="tag">${tag}</span>`;
        document.getElementById('viewBody').innerHTML = body;
        document.getElementById('modalView').style.display = 'flex';
    };

    async function carregarBoard() {
        if (!currentUID) return;
        const snap = await getDocs(query(collection(db, "planners", currentUID, "tasks"), orderBy("criadoEm", "desc")));
        const cols = { recent: document.getElementById("recent"), d1: document.getElementById("d1"), d7: document.getElementById("d7"), d21: document.getElementById("d21"), done: document.getElementById("done") };
        Object.values(cols).forEach(c => c.innerHTML = "");
        const agora = Date.now();

        snap.forEach(d => {
            const t = d.data();
            if (t.column !== 'done' && agora < t.targetDate) return; 

            const card = document.createElement("div");
            card.className = "card";
            card.id = d.id;
            card.draggable = true;
            card.ondragstart = (ev) => ev.dataTransfer.setData("text", ev.target.id);
            
            // Se for nota de texto, abre o modal ao clicar. Se for PDF, abre o link.
            card.onclick = () => {
                if(t.pdfUrl) window.open(t.pdfUrl, '_blank');
                else abrirNota(t.titulo, t.tag, t.content);
            };
            
            card.innerHTML = `
                <div style="font-size:13px; font-weight:500; margin-bottom:4px;">${t.titulo}</div>
                <span class="tag">${t.tag}</span>
            `;
            if (cols[t.column]) cols[t.column].appendChild(card);
        });
    }

    // Drag and Drop
    window.allowDrop = (ev) => ev.preventDefault();
    window.drop = async (ev) => {
        ev.preventDefault();
        const id = ev.dataTransfer.getData("text");
        const col = ev.currentTarget.id;
        await updateDoc(doc(db, "planners", currentUID, "tasks", id), { column: col });
        carregarBoard();
    };

    async function carregarBiblioteca() {
        if (!currentUID) return;
        const snap = await getDocs(query(collection(db, "planners", currentUID, "arquivos"), orderBy("data", "desc")));
        const container = document.getElementById("listaBiblioteca");
        container.innerHTML = "";
        snap.forEach(d => {
            const p = d.data();
            container.innerHTML += `
                <tr>
                    <td style="padding:10px;">${p.nome}</td>
                    <td style="padding:10px;"><span class="tag">${p.tag}</span></td>
                    <td style="padding:10px;">
                        <button class="btn-notion" onclick="${p.tipo === 'pdf' ? `window.open('${p.url}')` : `abrirNota('${p.nome}','${p.tag}',\`${p.content}\`)`}">Abrir</button>
                    </td>
                </tr>`;
        });
    }

    document.getElementById("navBoard").onclick = () => { document.getElementById("secBoard").classList.remove("hidden"); document.getElementById("secLib").classList.add("hidden"); };
    document.getElementById("navLib").onclick = () => { document.getElementById("secBoard").classList.add("hidden"); document.getElementById("secLib").classList.remove("hidden"); carregarBiblioteca(); };

</script>
</body>
</html>
