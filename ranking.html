<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking Geral da Turma</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #0f172a;
            --accent: #0ea5e9;
            --success: #10b981;
            --warning: #f59e0b;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text-muted: #64748b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--primary);
            margin: 0;
            padding: 40px 20px;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-weight: 800;
            font-size: 2.2rem;
            margin: 0;
            letter-spacing: -0.05rem;
            color: var(--primary);
        }

        p.subtitle {
            color: var(--text-muted);
            margin-top: 8px;
            font-size: 1rem;
        }

        /* Container da Lista */
        .ranking-container {
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            overflow: hidden; /* Para bordas arredondadas */
        }

        .ranking-header {
            display: grid;
            grid-template-columns: 60px 1fr 120px;
            padding: 15px 25px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Lista com Scroll se for muito grande */
        .scroll-area {
            max-height: 70vh; /* Ocupa no máximo 70% da altura da tela */
            overflow-y: auto;
            padding: 0;
        }

        /* Estilo das Linhas (Padrão) */
        .student-row {
            display: grid;
            grid-template-columns: 60px 1fr 120px;
            align-items: center;
            padding: 18px 25px;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.2s;
        }

        .student-row:hover {
            background-color: #f8fafc;
        }

        /* -- ESTILOS ESPECIAIS PARA O TOP 5 -- */
        .student-row.top-tier {
            background-color: #fff; /* Destaca branco puro */
            padding: 22px 25px; /* Um pouco maior */
        }
        
        /* Cores das Medalhas */
        .rank-number { font-weight: 800; font-size: 1.1rem; color: #cbd5e1; }
        
        .rank-1 .rank-number { color: #eab308; font-size: 1.5rem; text-shadow: 0 2px 10px rgba(234, 179, 8, 0.2); } /* Ouro */
        .rank-2 .rank-number { color: #94a3b8; font-size: 1.3rem; } /* Prata */
        .rank-3 .rank-number { color: #b45309; font-size: 1.3rem; } /* Bronze */
        .rank-4 .rank-number, .rank-5 .rank-number { color: var(--primary); } /* 4 e 5 destaque preto */

        .rank-others .rank-number { font-size: 0.9rem; font-weight: 600; } /* Resto menor */

        /* Informações do Aluno */
        .student-name {
            display: block;
            font-weight: 600;
            color: var(--primary);
        }
        
        .rank-others .student-name { font-weight: 400; } /* Nome normal para o resto */

        .simulado-tag {
            font-size: 0.75rem;
            color: var(--text-muted);
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 4px;
            display: inline-block;
        }

        /* Barra de Progresso */
        .score-box { text-align: right; }
        
        .score-val {
            display: block;
            font-weight: 800;
            font-size: 1.1rem;
            margin-bottom: 4px;
        }
        
        .rank-others .score-val { font-size: 0.9rem; } /* Nota menor para o resto */

        .progress-track {
            background: #e2e8f0;
            height: 6px;
            width: 100%;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 1s ease-out;
            border-radius: 3px;
        }

        /* Cores de desempenho */
        .high-score .progress-fill { background: var(--success); } /* Verde */
        .med-score .progress-fill { background: var(--accent); }   /* Azul */
        .low-score .progress-fill { background: var(--warning); }  /* Laranja */

        /* Loading e Botão */
        #loading { padding: 40px; text-align: center; color: var(--text-muted); }
        
        .btn-home {
            display: block;
            width: fit-content;
            margin: 30px auto;
            text-decoration: none;
            color: var(--text-muted);
            font-size: 0.9rem;
            border: 1px solid #cbd5e1;
            padding: 8px 20px;
            border-radius: 20px;
            transition: 0.3s;
        }
        .btn-home:hover { background: white; border-color: var(--primary); color: var(--primary); }

        /* Divisor Visual após o Top 5 */
        .divider-line {
            height: 10px;
            background: #f1f5f9;
            border-top: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
        }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Classificação Geral</h1>
            <p class="subtitle">Ranking de desempenho acumulado</p>
        </header>

        <div class="ranking-container">
            <div class="ranking-header">
                <span>#</span>
                <span>Estudante</span>
                <span style="text-align: right">Nota</span>
            </div>

            <div id="loading">Carregando dados...</div>
            
            <div class="scroll-area" id="ranking-list">
                </div>
        </div>

        <a href="index.html" class="btn-home">⬅ Voltar ao Início</a>
    </div>

    <script src="conexao_firebase.js"></script>

    <script>
        window.addEventListener('load', function() {
            carregarRankingCompleto();
        });

        async function carregarRankingCompleto() {
            const listaElement = document.getElementById('ranking-list');
            const loadingElement = document.getElementById('loading');

            try {
                const snapshot = await window.db.collection('resultados_alunos').get();

                if (snapshot.empty) {
                    loadingElement.innerText = "Ainda não há dados registrados.";
                    return;
                }

                // 1. Agrupa pela MELHOR nota de cada aluno
                const alunosMap = {};

                snapshot.forEach(doc => {
                    const dados = doc.data();
                    const nomeKey = dados.aluno.trim().toUpperCase(); 
                    
                    // Cálculo da porcentagem
                    let pct = 0;
                    if(dados.nota && dados.total_questoes) {
                        pct = (dados.nota / dados.total_questoes) * 100;
                    }

                    // Só atualiza se for uma nota maior
                    if (!alunosMap[nomeKey] || pct > alunosMap[nomeKey].pct) {
                        alunosMap[nomeKey] = {
                            nomeReal: dados.aluno,
                            pct: pct,
                            simulado: dados.simulado || "Geral"
                        };
                    }
                });

                // 2. Converte para lista e ordena
                let ranking = Object.values(alunosMap);
                ranking.sort((a, b) => b.pct - a.pct);

                loadingElement.style.display = 'none';

                // 3. Gera o HTML
                ranking.forEach((aluno, index) => {
                    const posicao = index + 1;
                    const isTop5 = posicao <= 5;
                    
                    // Define classes CSS baseadas na posição e nota
                    let rowClass = isTop5 ? `rank-${posicao} top-tier` : 'rank-others';
                    
                    // Divisor visual depois do 5º lugar (Opcional, mas fica bonito)
                    if (posicao === 6) {
                        listaElement.innerHTML += `<div class="divider-line"></div>`;
                    }

                    // Cor da barra
                    let scoreClass = 'low-score';
                    if (aluno.pct >= 80) scoreClass = 'high-score';
                    else if (aluno.pct >= 60) scoreClass = 'med-score';

                    const html = `
                        <div class="student-row ${rowClass}">
                            <div class="rank-number">${posicao}º</div>
                            <div class="student-info">
                                <span class="student-name">${aluno.nomeReal}</span>
                                ${isTop5 ? `<span class="simulado-tag">${aluno.simulado}</span>` : ''}
                            </div>
                            <div class="score-box ${scoreClass}">
                                <span class="score-val">${aluno.pct.toFixed(0)}%</span>
                                <div class="progress-track">
                                    <div class="progress-fill" style="width: ${aluno.pct}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    listaElement.innerHTML += html;
                });

            } catch (erro) {
                console.error(erro);
                loadingElement.innerText = "Erro ao conectar.";
            }
        }
    </script>

</body>
</html>

